{"pages":[{"title":"å‹é“¾","date":"2025-10-16T16:00:00.000Z","path":"links/index.html","text":""},{"title":"å…³äº","date":"2025-10-16T16:00:00.000Z","path":"about/index.html","text":"æ¸£æ¸£ç†Šçª"},{"title":"é¡¹ç›®","date":"2025-10-16T16:00:00.000Z","path":"repository/index.html","text":"ä»“åº“åˆ—è¡¨æš‚æœªå…¬å¼€ã€‚"},{"title":"æ ‡ç­¾","date":"2025-10-16T16:00:00.000Z","path":"tags/index.html","text":""},{"title":"åˆ†ç±»","date":"2025-10-16T16:00:00.000Z","path":"categories/index.html","text":""}],"posts":[{"title":"Ollamaæµå¼åº”ç­”æ¥å£é¡µé¢å¯¹æ¥","date":"2025-10-15T11:31:00.000Z","path":"2025/10/15/Ollamaæµå¼åº”ç­”æ¥å£é¡µé¢å¯¹æ¥/","text":"æœ¬èŠ‚éœ€æ±‚ å®ç°ä¸€æ¬¾ç®€å•çš„UIç•Œé¢ï¼Œä¸æœåŠ¡ç«¯ Ollama DeepSeek AI è¿›è¡Œå¯¹æ¥ å‰ç«¯ä»£ç  è¿™é‡Œç›´æ¥è´´ä¸€ä»½æˆ‘è‡ªå·±å’ŒAIå¤šæ¬¡å¯¹è¯å¾—åˆ°çš„ä¸€ä¸ªæ•ˆæœè¿˜ä¸é”™çš„HTML æ•ˆæœå±•ç¤º æ”¯æŒçš„åŠŸèƒ½ æ™®é€šè¯·æ±‚&#x2F;æµå¼è¯·æ±‚åˆ‡æ¢ ç”¨æˆ·å¯é€šè¿‡ç•Œé¢æŒ‰é’®åœ¨æ™®é€šè¯·æ±‚ï¼ˆä¸€æ¬¡æ€§è¿”å›å®Œæ•´æ¶ˆæ¯ï¼‰ä¸æµå¼è¯·æ±‚ï¼ˆé€æ®µè¿”å›æ¶ˆæ¯ï¼‰ä¹‹é—´åˆ‡æ¢ã€‚ å½“å‰æ¨¡å¼ä¼šåœ¨ç•Œé¢é¡¶éƒ¨æ˜¾ç¤ºï¼Œå¹¶é™„å¸¦ç®€è¦è¯´æ˜ã€‚ èŠå¤©è®°å½•å¿«æ·å¯¼èˆª æ”¯æŒé€šè¿‡é”®ç›˜çš„ â†‘&#x2F;â†“ ç®­å¤´å¿«é€Ÿåˆ‡æ¢ä¸Šä¸€æ¡æˆ–ä¸‹ä¸€æ¡ç”¨æˆ·å‘è¨€ï¼Œæ–¹ä¾¿é‡å¤å‘é€æˆ–ä¿®æ”¹ã€‚ Markdown æ ¼å¼æ¸²æŸ“ æœåŠ¡ç«¯è¿”å›çš„æ¶ˆæ¯æ”¯æŒ Markdown æ ¼å¼ï¼Œå‰ç«¯ä¼šè‡ªåŠ¨è§£æå¹¶æ¸²æŸ“ï¼ŒåŒ…æ‹¬ä»£ç å—ã€åˆ—è¡¨ã€è¡¨æ ¼ç­‰ã€‚ æ·±åº¦æ€è€ƒä¸æ™®é€šè¾“å‡ºåŒºåˆ† æ¨¡å‹çš„â€œæ·±åº¦æ€è€ƒâ€çŠ¶æ€ä¼šä»¥ç‰¹æ®Šæ ·å¼ï¼ˆå¦‚ç°è‰²èƒŒæ™¯æç¤ºæ¡†ï¼‰æ˜¾ç¤ºï¼Œæ™®é€šè¾“å‡ºåˆ™ä»¥å¸¸è§„æ°”æ³¡æ ·å¼å±•ç¤ºã€‚ æ—¥å¿—åŠŸèƒ½ æä¾›æ—¥å¿—é¢æ¿ï¼Œè®°å½•ç”¨æˆ·è¯·æ±‚ä¸æœåŠ¡ç«¯å“åº”çš„è¯¦ç»†ä¿¡æ¯ï¼Œä¾¿äºè°ƒè¯•ä¸é—®é¢˜æ’æŸ¥ã€‚ æ—¥å¿—æ”¯æŒæŸ¥çœ‹ã€æ¸…ç©ºç­‰æ“ä½œï¼Œæå‡å¼€å‘ä¸æµ‹è¯•æ•ˆç‡ã€‚ å…·ä½“ä»£ç 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135136137138139140141142143144145146147148149150151152153154155156157158159160161162163164165166167168169170171172173174175176177178179180181182183184185186187188189190191192193194195196197198199200201202203204205206207208209210211212213214215216217218219220221222223224225226227228229230231232233234235236237238239240241242243244245246247248249250251252253254255256257258259260261262263264265266267268269270271272273274275276277278279280281282283284285286287288289290291292293294295296297298299300301302303304305306307308309310311312313314315316317318319320321322323324325326327328329330331332333334335336337338339340341342343344345346347348349350351352353354355356357358359360361362363364365366367368369370371372373374375376377378379380381382383384385386387388389390391392393394395396397398399400401402403404405406407408409410411412413414415416417418419420421422423424425426427428429430431432433434435436437438439440441442443444445446447448449450451452453454455456457458459460461462463464465466467468469470471472473474475476477478479480481482483484485486487488489490491492493494495496497498499500501502503504505506507508509510511512513514515516517518519520521522523524525526527528529530531532533534535536537538539540541542543544545546547548549550551552553554555556557558559560561562563564565566567568569570571572573574575576577578&lt;!DOCTYPE html&gt;&lt;html lang=&quot;zh-CN&quot;&gt;&lt;head&gt; &lt;meta charset=&quot;UTF-8&quot; /&gt; &lt;meta name=&quot;viewport&quot; content=&quot;width=device-width, initial-scale=1.0&quot; /&gt; &lt;title&gt;AI Chatbot&lt;/title&gt; &lt;script src=&quot;https://cdn.tailwindcss.com&quot;&gt;&lt;/script&gt; &lt;script src=&quot;https://cdn.jsdelivr.net/npm/marked/marked.min.js&quot;&gt;&lt;/script&gt; &lt;link rel=&quot;stylesheet&quot; href=&quot;https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.2/css/all.min.css&quot; integrity=&quot;sha512-SnF4j8kH9Yp5VX1nA2nayJ9uj9Y6p9cHfGppRy5JyE2tdI9lbEKeosFVJeFt3PcTJS3BM4tiTqcK3wwD5cqvug==&quot; crossorigin=&quot;anonymous&quot; referrerpolicy=&quot;no-referrer&quot; /&gt; &lt;link href=&quot;https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&amp;family=Poppins:wght@400;500;600&amp;display=swap&quot; rel=&quot;stylesheet&quot; /&gt; &lt;style&gt; :root &#123; color-scheme: light; &#125; body.web-page &#123; font-family: &#x27;Inter&#x27;, &#x27;Poppins&#x27;, -apple-system, BlinkMacSystemFont, &#x27;Segoe UI&#x27;, &#x27;PingFang SC&#x27;, &#x27;Microsoft YaHei&#x27;, sans-serif; background: radial-gradient(circle at 15% 20%, rgba(151, 190, 255, 0.22), transparent 55%), radial-gradient(circle at 85% 10%, rgba(120, 180, 255, 0.18), transparent 50%), linear-gradient(180deg, #F4F7FB 0%, #E3F0FF 100%); min-height: 100vh; color: #1F2430; &#125; .glass-card &#123; backdrop-filter: blur(10px); background: rgba(243, 248, 255, 0.9); border: 1px solid rgba(138, 163, 210, 0.2); box-shadow: 0 16px 36px -24px rgba(34, 61, 120, 0.28); &#125; .signal-gradient &#123; background: linear-gradient(90deg, #5A8DEE 0%, #7AD1F8 100%); &#125; #conversation &#123; max-height: 60vh; &#125; /* Markdown æ ·å¼ */ .ai-message pre &#123; background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px; padding: 12px; margin: 8px 0; overflow-x: auto; font-size: 13px; line-height: 1.4; &#125; .ai-message code &#123; background: #f1f3f4; color: #d73a49; padding: 2px 6px; border-radius: 3px; font-size: 12px; font-family: &#x27;SFMono-Regular&#x27;, Consolas, &#x27;Liberation Mono&#x27;, Menlo, monospace; &#125; .ai-message pre code &#123; background: transparent; color: inherit; padding: 0; border-radius: 0; &#125; .ai-message h1, .ai-message h2, .ai-message h3 &#123; color: #1f2937; margin: 16px 0 8px 0; font-weight: 600; &#125; .ai-message h1 &#123; font-size: 1.5em; &#125; .ai-message h2 &#123; font-size: 1.25em; &#125; .ai-message h3 &#123; font-size: 1.125em; &#125; .ai-message p &#123; margin: 8px 0; line-height: 1.6; &#125; .ai-message ul, .ai-message ol &#123; margin: 8px 0; padding-left: 24px; &#125; .ai-message li &#123; margin: 4px 0; &#125; .ai-message blockquote &#123; border-left: 4px solid #e5e7eb; padding-left: 16px; margin: 12px 0; color: #6b7280; font-style: italic; &#125; .ai-message table &#123; border-collapse: collapse; margin: 12px 0; width: 100%; &#125; .ai-message th, .ai-message td &#123; border: 1px solid #e5e7eb; padding: 8px 12px; text-align: left; &#125; .ai-message th &#123; background: #f9fafb; font-weight: 600; &#125; &lt;/style&gt;&lt;/head&gt;&lt;body class=&quot;web-page&quot;&gt; &lt;div class=&quot;max-w-screen-xl mx-auto h-screen px-6 md:px-10 pt-10 pb-16 flex flex-col&quot;&gt; &lt;header class=&quot;mb-10 flex flex-col md:flex-row md:items-center md:justify-between gap-5&quot;&gt; &lt;div class=&quot;flex items-center gap-3&quot;&gt; &lt;span class=&quot;w-12 h-12 rounded-2xl signal-gradient flex items-center justify-center text-white text-2xl font-semibold shadow-lg shadow-blue-100/60&quot;&gt;&lt;/span&gt; &lt;div&gt; &lt;h1 class=&quot;text-2xl font-semibold tracking-tight text-slate-800&quot;&gt;AI Chatbot&lt;/h1&gt; &lt;p class=&quot;text-sm text-slate-500&quot;&gt;Deepseek R1:1.5B&lt;/p&gt; &lt;/div&gt; &lt;/div&gt; &lt;div class=&quot;glass-card rounded-2xl px-6 py-4 flex items-center gap-4 max-w-2xl&quot;&gt; &lt;div class=&quot;min-w-[140px]&quot;&gt; &lt;p class=&quot;text-xs uppercase tracking-[0.18em] text-slate-500&quot;&gt;å½“å‰æ¨¡å¼&lt;/p&gt; &lt;p id=&quot;modeLabel&quot; class=&quot;text-lg font-semibold text-slate-700&quot;&gt;æ™®é€šè¯·æ±‚&lt;/p&gt; &lt;/div&gt; &lt;div class=&quot;flex-1 text-xs text-slate-500 leading-relaxed&quot;&gt; &lt;p id=&quot;modeDescription&quot;&gt;ä¸€æ¬¡æ€§è¿”å›å®Œæ•´æ¶ˆæ¯ã€‚&lt;/p&gt; &lt;p id=&quot;modeHint&quot; class=&quot;mt-1&quot;&gt;ç‚¹å‡»åº•éƒ¨æŒ‰é’®å¯åˆ‡æ¢è‡³æµå¼æ¨¡å¼ã€‚&lt;/p&gt; &lt;/div&gt; &lt;button id=&quot;logToggle&quot; type=&quot;button&quot; class=&quot;shrink-0 h-11 px-4 rounded-xl border border-slate-200/80 text-sm font-medium text-slate-600 flex items-center gap-2 transition hover:border-sky-300 hover:text-sky-600&quot;&gt; &lt;i class=&quot;fa-regular fa-file-lines&quot;&gt;&lt;/i&gt; æŸ¥çœ‹æ—¥å¿— &lt;/button&gt; &lt;/div&gt; &lt;/header&gt; &lt;main class=&quot;flex-1 flex flex-col overflow-hidden&quot;&gt; &lt;section class=&quot;glass-card rounded-3xl flex-1 overflow-hidden flex flex-col&quot;&gt; &lt;div class=&quot;px-8 pt-8 pb-4 border-b border-slate-200/60&quot;&gt; &lt;h2 class=&quot;text-sm font-semibold text-slate-600 uppercase tracking-wide&quot;&gt;å¯¹è¯åŒº&lt;/h2&gt; &lt;p class=&quot;text-xs text-slate-500 mt-1&quot;&gt;ç”¨äºå±•ç¤ºå®æ—¶çš„æ¨¡å‹å›å¤ä¸ç”¨æˆ·æ¶ˆæ¯ã€‚&lt;/p&gt; &lt;/div&gt; &lt;div id=&quot;conversation&quot; class=&quot;flex-1 px-8 py-6 overflow-y-auto space-y-4&quot;&gt; &lt;div class=&quot;h-full flex flex-col items-center justify-center text-sm text-slate-400&quot; data-empty-state=&quot;true&quot;&gt; &lt;i class=&quot;fa-regular fa-comment-dots text-xl mb-2&quot;&gt;&lt;/i&gt; &lt;p&gt;è¿˜æ²¡æœ‰æ¶ˆæ¯ï¼Œè¾“å…¥å†…å®¹å¼€å§‹å¯¹è¯å§ã€‚&lt;/p&gt; &lt;/div&gt; &lt;/div&gt; &lt;/section&gt; &lt;section class=&quot;mt-8&quot;&gt; &lt;form class=&quot;glass-card rounded-3xl px-6 py-4 flex flex-col md:flex-row gap-4 md:items-center&quot; id=&quot;chatForm&quot;&gt; &lt;button type=&quot;button&quot; id=&quot;modeToggle&quot; class=&quot;w-full md:w-auto md:min-w-[160px] h-12 rounded-2xl border border-sky-200/70 text-sky-600 text-sm font-medium flex items-center justify-center gap-2 transition hover:border-sky-400 hover:text-sky-700&quot;&gt; &lt;i class=&quot;fa-solid fa-repeat&quot;&gt;&lt;/i&gt; &lt;span id=&quot;modeToggleLabel&quot;&gt;åˆ‡æ¢åˆ°æµå¼è¯·æ±‚&lt;/span&gt; &lt;/button&gt; &lt;div class=&quot;flex-1 flex items-center gap-3&quot;&gt; &lt;input type=&quot;text&quot; id=&quot;messageInput&quot; class=&quot;flex-1 h-12 rounded-2xl border border-transparent bg-white/85 px-4 text-sm text-slate-700 placeholder:text-slate-400 focus:outline-none focus:ring-2 focus:ring-sky-200&quot; placeholder=&quot;ç›´æ¥è¾“å…¥å†…å®¹å³å¯ï¼Œä¸éœ€è¦å‘½ä»¤&quot; autocomplete=&quot;off&quot; required /&gt; &lt;button type=&quot;submit&quot; class=&quot;w-12 h-12 rounded-2xl signal-gradient text-white flex items-center justify-center text-lg shadow-md shadow-blue-200/60 transition hover:shadow-lg hover:-translate-y-0.5&quot;&gt; &lt;i class=&quot;fa-solid fa-paper-plane&quot;&gt;&lt;/i&gt; &lt;/button&gt; &lt;/div&gt; &lt;/form&gt; &lt;/section&gt; &lt;/main&gt; &lt;/div&gt; &lt;aside id=&quot;logPanel&quot; class=&quot;hidden fixed bottom-6 right-6 w-[320px] max-h-[60vh] glass-card rounded-3xl p-5 flex flex-col shadow-2xl shadow-blue-200/50&quot;&gt; &lt;div class=&quot;flex items-center justify-between mb-3&quot;&gt; &lt;div&gt; &lt;p class=&quot;text-xs uppercase tracking-[0.2em] text-slate-500&quot;&gt;è¯·æ±‚æ—¥å¿—&lt;/p&gt; &lt;p class=&quot;text-sm font-semibold text-slate-700&quot;&gt;æœ€è¿‘æ´»åŠ¨&lt;/p&gt; &lt;/div&gt; &lt;button id=&quot;logClose&quot; type=&quot;button&quot; class=&quot;w-9 h-9 rounded-lg border border-slate-200/80 text-slate-400 hover:text-slate-600 hover:border-sky-300 transition&quot;&gt; &lt;i class=&quot;fa-solid fa-xmark&quot;&gt;&lt;/i&gt; &lt;/button&gt; &lt;/div&gt; &lt;div class=&quot;flex-1 overflow-y-auto pr-1&quot;&gt; &lt;ul id=&quot;logList&quot; class=&quot;space-y-3 text-xs text-slate-500&quot;&gt;&lt;/ul&gt; &lt;/div&gt; &lt;button id=&quot;logClear&quot; type=&quot;button&quot; class=&quot;mt-4 w-full h-10 rounded-xl border border-slate-200/80 text-[13px] text-slate-500 hover:border-sky-300 hover:text-sky-600 transition&quot;&gt;æ¸…ç©ºæ—¥å¿—&lt;/button&gt; &lt;/aside&gt; &lt;script&gt; const DEFAULT_MODEL = &#x27;deepseek-r1:1.5b&#x27;; const modeToggle = document.getElementById(&#x27;modeToggle&#x27;); const modeToggleLabel = document.getElementById(&#x27;modeToggleLabel&#x27;); const modeLabel = document.getElementById(&#x27;modeLabel&#x27;); const modeDescription = document.getElementById(&#x27;modeDescription&#x27;); const modeHint = document.getElementById(&#x27;modeHint&#x27;); const logToggle = document.getElementById(&#x27;logToggle&#x27;); const logPanel = document.getElementById(&#x27;logPanel&#x27;); const logClose = document.getElementById(&#x27;logClose&#x27;); const logClear = document.getElementById(&#x27;logClear&#x27;); const logList = document.getElementById(&#x27;logList&#x27;); const messageInput = document.getElementById(&#x27;messageInput&#x27;); const conversation = document.getElementById(&#x27;conversation&#x27;); const chatForm = document.getElementById(&#x27;chatForm&#x27;); const submitButton = chatForm.querySelector(&#x27;button[type=&quot;submit&quot;]&#x27;); const modes = &#123; standard: &#123; name: &#x27;æ™®é€šè¯·æ±‚&#x27;, description: &#x27;ä¸€æ¬¡æ€§è¿”å›å®Œæ•´æ¶ˆæ¯ã€‚&#x27;, hint: &#x27;ç‚¹å‡»åº•éƒ¨æŒ‰é’®å¯åˆ‡æ¢è‡³æµå¼æ¨¡å¼ã€‚&#x27;, toggleText: &#x27;åˆ‡æ¢åˆ°æµå¼è¯·æ±‚&#x27;, next: &#x27;stream&#x27; &#125;, stream: &#123; name: &#x27;æµå¼è¯·æ±‚&#x27;, description: &#x27;é€æ®µè¿”å›ï¼Œé€‚åˆå®æ—¶å±•ç¤ºã€‚&#x27;, hint: &#x27;ç‚¹å‡»åº•éƒ¨æŒ‰é’®å¯åˆ‡æ¢è‡³æ™®é€šæ¨¡å¼ã€‚&#x27;, toggleText: &#x27;åˆ‡æ¢åˆ°æ™®é€šè¯·æ±‚&#x27;, next: &#x27;standard&#x27; &#125; &#125;; let currentMode = &#x27;standard&#x27;; let isRequestPending = false; const logs = []; const sentMessages = []; // ç”¨äºå­˜å‚¨ç”¨æˆ·å‘é€çš„æ¶ˆæ¯ let historyIndex = -1; // ç”¨äºè¿½è¸ªå†å²è®°å½•çš„ä½ç½® function updateModeUI() &#123; const &#123; name, description, hint, toggleText &#125; = modes[currentMode]; modeLabel.textContent = name; modeDescription.textContent = description; modeHint.textContent = hint; modeToggleLabel.textContent = toggleText; modeToggle.dataset.mode = currentMode; modeToggle.setAttribute(&#x27;aria-pressed&#x27;, currentMode === &#x27;stream&#x27;); modeToggle.title = `$&#123;name&#125; Â· $&#123;description&#125;`; &#125; function createMessagePreview(text) &#123; const trimmed = text.replace(/\\s+/g, &#x27; &#x27;).trim(); return trimmed.length &gt; 60 ? `$&#123;trimmed.slice(0, 60)&#125;â€¦` : trimmed; &#125; function removeEmptyState() &#123; const emptyState = conversation.querySelector(&#x27;[data-empty-state]&#x27;); if (emptyState) &#123; emptyState.remove(); &#125; &#125; function appendUserMessage(text) &#123; const wrapper = document.createElement(&#x27;div&#x27;); wrapper.className = &#x27;flex justify-end&#x27;; const bubble = document.createElement(&#x27;div&#x27;); bubble.className = &#x27;max-w-[70%] rounded-3xl bg-sky-100/80 px-4 py-3 text-sm text-slate-700 leading-relaxed shadow-sm whitespace-pre-wrap break-words&#x27;; bubble.textContent = text; wrapper.appendChild(bubble); conversation.appendChild(wrapper); conversation.scrollTop = conversation.scrollHeight; &#125; function appendAssistantMessage(initialText = &#x27;æ¨¡å‹ç”Ÿæˆä¸­â€¦&#x27;) &#123; const wrapper = document.createElement(&#x27;div&#x27;); wrapper.className = &#x27;flex gap-3&#x27;; const avatar = document.createElement(&#x27;div&#x27;); avatar.className = &#x27;w-9 h-9 rounded-full signal-gradient text-white flex items-center justify-center shadow-md&#x27;; avatar.innerHTML = &#x27;&lt;i class=&quot;fa-solid fa-robot&quot;&gt;&lt;/i&gt;&#x27;; const body = document.createElement(&#x27;div&#x27;); body.className = &#x27;max-w-[72%] rounded-3xl bg-white/90 border border-slate-200/60 px-4 py-3 text-sm text-slate-700 leading-relaxed shadow-sm whitespace-pre-wrap break-words ai-message&#x27;; const thinkDiv = document.createElement(&#x27;div&#x27;); thinkDiv.className = &#x27;mb-2 text-xs text-slate-400 bg-slate-50/50 px-2 py-1 rounded-lg border-l-2 border-slate-300&#x27;; thinkDiv.style.display = &#x27;none&#x27;; thinkDiv.innerHTML = &#x27;&lt;strong&gt;æ·±åº¦æ€è€ƒ...&lt;/strong&gt;&lt;br&gt;&#x27;; const contentDiv = document.createElement(&#x27;div&#x27;); contentDiv.textContent = initialText; body.appendChild(thinkDiv); body.appendChild(contentDiv); wrapper.append(avatar, body); conversation.appendChild(wrapper); conversation.scrollTop = conversation.scrollHeight; return &#123; bubble: body, thinkDiv, contentDiv &#125;; &#125; function appendSystemMessage(text) &#123; const wrapper = document.createElement(&#x27;div&#x27;); wrapper.className = &#x27;flex gap-3&#x27;; const badge = document.createElement(&#x27;div&#x27;); badge.className = &#x27;w-9 h-9 rounded-full bg-rose-100 text-rose-500 flex items-center justify-center shadow-sm&#x27;; badge.innerHTML = &#x27;&lt;i class=&quot;fa-solid fa-circle-exclamation&quot;&gt;&lt;/i&gt;&#x27;; const body = document.createElement(&#x27;div&#x27;); const bubble = document.createElement(&#x27;div&#x27;); bubble.className = &#x27;max-w-[72%] rounded-3xl bg-white border border-rose-200 px-4 py-3 text-sm text-rose-600 leading-relaxed whitespace-pre-wrap break-words&#x27;; bubble.textContent = text; body.appendChild(bubble); wrapper.append(badge, body); conversation.appendChild(wrapper); conversation.scrollTop = conversation.scrollHeight; &#125; function addLog(text) &#123; logs.unshift(&#123; text, timestamp: new Date().toLocaleTimeString() &#125;); if (logs.length &gt; 120) &#123; logs.pop(); &#125; renderLogs(); &#125; function renderLogs() &#123; logList.innerHTML = &#x27;&#x27;; if (!logs.length) &#123; const emptyItem = document.createElement(&#x27;li&#x27;); emptyItem.className = &#x27;text-slate-400 text-center py-4&#x27;; emptyItem.textContent = &#x27;æš‚æ— æ—¥å¿—&#x27;; logList.appendChild(emptyItem); return; &#125; logs.forEach((&#123; text, timestamp &#125;) =&gt; &#123; const item = document.createElement(&#x27;li&#x27;); item.className = &#x27;rounded-2xl border border-slate-200/60 bg-white/80 px-3 py-2.5 shadow-sm&#x27;; item.innerHTML = ` &lt;p class=&quot;text-[11px] text-slate-400&quot;&gt;$&#123;timestamp&#125;&lt;/p&gt; &lt;p class=&quot;mt-1 text-slate-600 leading-relaxed&quot;&gt;$&#123;text&#125;&lt;/p&gt; `; logList.appendChild(item); &#125;); &#125; function toggleFormDisabled(disabled) &#123; submitButton.disabled = disabled; messageInput.disabled = disabled; modeToggle.disabled = disabled; submitButton.classList.toggle(&#x27;opacity-60&#x27;, disabled); submitButton.classList.toggle(&#x27;cursor-not-allowed&#x27;, disabled); messageInput.classList.toggle(&#x27;opacity-70&#x27;, disabled); &#125; modeToggle.addEventListener(&#x27;click&#x27;, () =&gt; &#123; if (isRequestPending) return; currentMode = modes[currentMode].next; updateModeUI(); &#125;); logToggle.addEventListener(&#x27;click&#x27;, () =&gt; &#123; logPanel.classList.toggle(&#x27;hidden&#x27;); if (!logPanel.classList.contains(&#x27;hidden&#x27;)) &#123; renderLogs(); &#125; &#125;); logClose.addEventListener(&#x27;click&#x27;, () =&gt; &#123; logPanel.classList.add(&#x27;hidden&#x27;); &#125;); logClear.addEventListener(&#x27;click&#x27;, () =&gt; &#123; logs.length = 0; renderLogs(); &#125;); chatForm.addEventListener(&#x27;submit&#x27;, async (event) =&gt; &#123; event.preventDefault(); const text = messageInput.value.trim(); if (!text || isRequestPending) &#123; return; &#125; // æ·»åŠ åˆ°å†å²è®°å½• if (sentMessages[0] !== text) &#123; sentMessages.unshift(text); &#125; historyIndex = -1; // é‡ç½®å†å²è®°å½•ç´¢å¼• removeEmptyState(); appendUserMessage(text); messageInput.value = &#x27;&#x27;; messageInput.focus(); const preview = createMessagePreview(text); addLog(`å‡†å¤‡å‘é€ $&#123;modes[currentMode].name&#125;ï¼š$&#123;preview&#125;`); const aiBubble = appendAssistantMessage(); isRequestPending = true; toggleFormDisabled(true); try &#123; await dispatchRequest(text, aiBubble); &#125; catch (error) &#123; console.error(error); addLog(`$&#123;modes[currentMode].name&#125; è¯·æ±‚å¤±è´¥ï¼š$&#123;error.message&#125;`); appendSystemMessage(`è¯·æ±‚å¤±è´¥ï¼š$&#123;error.message&#125;`); &#125; finally &#123; isRequestPending = false; toggleFormDisabled(false); &#125; &#125;); async function dispatchRequest(message, aiBubble) &#123; const endpoint = currentMode === &#x27;standard&#x27; ? &#x27;generate&#x27; : &#x27;generate_stream&#x27;; const url = `/api/v1/ollama/$&#123;endpoint&#125;?model=$&#123;encodeURIComponent(DEFAULT_MODEL)&#125;&amp;message=$&#123;encodeURIComponent(message)&#125;`; addLog(`è¯·æ±‚ URLï¼š$&#123;url&#125;`); try &#123; if (currentMode === &#x27;standard&#x27;) &#123; const &#123; status &#125; = await handleStandardRequest(url, aiBubble); addLog(`æ™®é€šè¯·æ±‚æˆåŠŸ Â· HTTP $&#123;status&#125;`); &#125; else &#123; const &#123; status &#125; = await handleStreamRequest(url, aiBubble); addLog(`æµå¼è¯·æ±‚æˆåŠŸ Â· HTTP $&#123;status&#125;`); &#125; &#125; catch (error) &#123; aiBubble.contentDiv.innerHTML = marked.parse(`è¯·æ±‚å¤±è´¥ï¼š$&#123;error.message&#125;`); throw error; &#125; &#125; async function handleStandardRequest(url, aiBubble) &#123; const response = await fetch(url); const status = response.status; if (!response.ok) &#123; const errorText = await response.text().catch(() =&gt; &#x27;&#x27;); throw new Error(`HTTP $&#123;status&#125;$&#123;errorText ? ` Â· $&#123;errorText&#125;` : &#x27;&#x27;&#125;`); &#125; const contentType = response.headers.get(&#x27;content-type&#x27;) || &#x27;&#x27;; let fullText; if (contentType.includes(&#x27;application/json&#x27;)) &#123; const data = await response.json(); fullText = extractContent(data); &#125; else &#123; fullText = await response.text(); &#125; // è§£æ think å’Œæ­£æ–‡ const thinkMatch = fullText.match(/&lt;think&gt;([\\s\\S]*?)&lt;\\/think&gt;/); const thinkContent = thinkMatch ? thinkMatch[1].trim() : &#x27;æ­£åœ¨æ€è€ƒä¸­...&#x27;; const mainContent = fullText.replace(/&lt;think&gt;[\\s\\S]*?&lt;\\/think&gt;\\s*/, &#x27;&#x27;).trim(); aiBubble.thinkDiv.style.display = &#x27;block&#x27;; aiBubble.thinkDiv.innerHTML = &#x27;&lt;strong&gt;æ·±åº¦æ€è€ƒå®Œæ¯•&lt;/strong&gt;&lt;br&gt;&#x27; + thinkContent.replace(/\\n/g, &#x27;&lt;br&gt;&#x27;); aiBubble.contentDiv.innerHTML = marked.parse(mainContent || &#x27;ï¼ˆæ¨¡å‹æ²¡æœ‰è¿”å›å†…å®¹ï¼‰&#x27;); conversation.scrollTop = conversation.scrollHeight; return &#123; status &#125;; &#125; async function handleStreamRequest(url, aiBubble) &#123; const response = await fetch(url); const status = response.status; if (!response.ok) &#123; const errorText = await response.text().catch(() =&gt; &#x27;&#x27;); throw new Error(`HTTP $&#123;status&#125;$&#123;errorText ? ` Â· $&#123;errorText&#125;` : &#x27;&#x27;&#125;`); &#125; // é‡ç½®å†…å®¹ aiBubble.contentDiv.textContent = &#x27;&#x27;; aiBubble.thinkDiv.style.display = &#x27;none&#x27;; const data = await response.json(); if (Array.isArray(data)) &#123; // åç«¯è¿”å›çš„æ˜¯ä¸€ä¸ªå®Œæ•´çš„JSONæ•°ç»„ let fullText = &#x27;&#x27;; for (const item of data) &#123; const content = extractContent(item); if (content) &#123; fullText += content; // ç›´æ¥æ›´æ–°æ–‡æœ¬å†…å®¹ï¼Œä¸å†è°ƒç”¨ä¼šé‡æ–°æ¸²æŸ“çš„å‡½æ•° updateStreamDisplay(fullText, aiBubble, true); &#125; // æ·»åŠ å»¶è¿Ÿï¼Œæ¨¡æ‹Ÿæµå¼æ•ˆæœ await new Promise(resolve =&gt; setTimeout(resolve, 100)); &#125; &#125; else &#123; // å¤„ç†å…¶ä»–å¯èƒ½çš„JSONç»“æ„æˆ–é”™è¯¯ const content = extractContent(data); if (content) &#123; updateStreamDisplay(content, aiBubble, false); &#125; else &#123; aiBubble.contentDiv.innerHTML = marked.parse(&#x27;ï¼ˆæ¨¡å‹æ²¡æœ‰è¿”å›æœ‰æ•ˆå†…å®¹ï¼‰&#x27;); &#125; &#125; return &#123; status &#125;; &#125; // ä»å•è¡Œæ•°æ®ä¸­æå–å†…å®¹ // function extractContentFromLine(line) &#123; ... &#125; // æ­¤å‡½æ•°å·²ä¸å†éœ€è¦ // æ›´æ–°æµå¼æ˜¾ç¤º function updateStreamDisplay(fullText, aiBubble, isStreaming) &#123; // å¤„ç† think æ ‡ç­¾ const thinkMatch = fullText.match(/&lt;think&gt;([\\s\\S]*?)(&lt;\\/think&gt;|$)/); if (thinkMatch) &#123; if (!thinkMatch[2]) &#123; // æ€è€ƒä¸­ const thinkContent = thinkMatch[1]; aiBubble.thinkDiv.style.display = &#x27;block&#x27;; aiBubble.thinkDiv.innerHTML = &#x27;&lt;strong&gt;æ·±åº¦æ€è€ƒä¸­...&lt;/strong&gt;&lt;br&gt;&#x27; + thinkContent.replace(/\\n/g, &#x27;&lt;br&gt;&#x27;); aiBubble.contentDiv.textContent = &#x27;&#x27;; &#125; else &#123; // æ€è€ƒå®Œæˆ const thinkContent = thinkMatch[1].trim(); aiBubble.thinkDiv.style.display = &#x27;block&#x27;; aiBubble.thinkDiv.innerHTML = &#x27;&lt;strong&gt;æ·±åº¦æ€è€ƒå®Œæ¯•&lt;/strong&gt;&lt;br&gt;&#x27; + thinkContent.replace(/\\n/g, &#x27;&lt;br&gt;&#x27;); // æå–å¹¶æ˜¾ç¤ºä¸»è¦å†…å®¹ const mainContent = fullText.replace(/&lt;think&gt;[\\s\\S]*?&lt;\\/think&gt;\\s*/, &#x27;&#x27;).trim(); aiBubble.contentDiv.innerHTML = marked.parse(mainContent); &#125; &#125; else &#123; // ç›´æ¥æ˜¾ç¤ºä¸»è¦å†…å®¹ aiBubble.contentDiv.innerHTML = marked.parse(fullText); &#125; conversation.scrollTop = conversation.scrollHeight; &#125; // é€å­—æ˜¾ç¤ºå†…å®¹ // displayContentGradually å‡½æ•°å·²å®Œå…¨åˆ é™¤ï¼Œä¸å†éœ€è¦ // å¤„ç†éæµå¼å“åº” // async function processCompleteResponse(text, aiBubble) &#123; ... &#125; // æ­¤å‡½æ•°å·²ä¸å†éœ€è¦ function extractContent(data) &#123; if (!data) return &#x27;&#x27;; if (typeof data === &#x27;string&#x27;) return data; const maybeContent = data?.result?.output?.content ?? data?.result?.output?.text ?? data?.output?.content ?? data?.message ?? data?.choices?.[0]?.message?.content ?? data?.results?.[0]?.output?.content; if (Array.isArray(maybeContent)) &#123; return maybeContent.map((item) =&gt; &#123; if (typeof item === &#x27;string&#x27;) return item; if (item?.text) return item.text; return &#x27;&#x27;; &#125;).join(&#x27;\\n&#x27;); &#125; if (typeof maybeContent === &#x27;object&#x27; &amp;&amp; maybeContent !== null) &#123; if (maybeContent.text) return maybeContent.text; return &#x27;&#x27;; &#125; if (maybeContent) &#123; return String(maybeContent); &#125; return &#x27;&#x27;; &#125; // åˆå§‹åŒ–ç•Œé¢ updateModeUI(); renderLogs(); messageInput.addEventListener(&#x27;keydown&#x27;, (event) =&gt; &#123; if (event.key === &#x27;ArrowUp&#x27;) &#123; event.preventDefault(); if (sentMessages.length &gt; 0 &amp;&amp; historyIndex &lt; sentMessages.length - 1) &#123; historyIndex++; messageInput.value = sentMessages[historyIndex]; messageInput.setSelectionRange(messageInput.value.length, messageInput.value.length); &#125; &#125; else if (event.key === &#x27;ArrowDown&#x27;) &#123; event.preventDefault(); if (historyIndex &gt; 0) &#123; historyIndex--; messageInput.value = sentMessages[historyIndex]; messageInput.setSelectionRange(messageInput.value.length, messageInput.value.length); &#125; else if (historyIndex &lt;= 0) &#123; historyIndex = -1; messageInput.value = &#x27;&#x27;; &#125; &#125; &#125;); &lt;/script&gt;&lt;/body&gt;&lt;/html&gt;","tags":[{"name":"å‰ç«¯é¡µé¢","slug":"å‰ç«¯é¡µé¢","permalink":"https://www.zhazhabear.site/tags/%E5%89%8D%E7%AB%AF%E9%A1%B5%E9%9D%A2/"},{"name":"é¡¹ç›®å­¦ä¹ ","slug":"é¡¹ç›®å­¦ä¹ ","permalink":"https://www.zhazhabear.site/tags/%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0/"}],"categories":[{"name":"AI Agentå­¦ä¹ ","slug":"AI-Agentå­¦ä¹ ","permalink":"https://www.zhazhabear.site/categories/AI-Agent%E5%AD%A6%E4%B9%A0/"}]},{"title":"Ollamaæµå¼åº”ç­”æ¥å£å®ç°","date":"2025-10-15T07:45:00.000Z","path":"2025/10/15/Ollamaæµå¼åº”ç­”æ¥å£å®ç°/","text":"æœ¬èŠ‚éœ€æ±‚ å¼•å…¥ Spring AI æ¡†æ¶ç»„ä»¶ï¼Œå¯¹æ¥ Ollama DeepSeek æä¾›æœåŠ¡æ¥å£ã€‚åŒ…æ‹¬:æ™®é€šåº”ç­”æ¥å£å’Œæµå¼æ¥å£ã€‚ æ™®é€šè¯·æ±‚ï¼ˆåŒæ­¥è¯·æ±‚ï¼‰æ™®é€šè¯·æ±‚æ˜¯æŒ‡å®¢æˆ·ç«¯ä¸€æ¬¡æ€§å‘é€è¯·æ±‚ï¼ŒæœåŠ¡ç«¯å¤„ç†å®Œæ¯•åä¸€æ¬¡æ€§è¿”å›å®Œæ•´çš„ç»“æœã€‚ä¾‹å¦‚ï¼š æµå¼è¯·æ±‚æµå¼è¯·æ±‚æ˜¯æŒ‡å®¢æˆ·ç«¯å‘é€è¯·æ±‚åï¼ŒæœåŠ¡ç«¯ä¼šå°†ç»“æœåˆ†æ‰¹æ¬¡ï¼Œé€æ­¥æ¨é€ç»™å®¢æˆ·ç«¯ï¼Œå®¢æˆ·ç«¯å¯ä»¥è¾¹æ¥æ”¶è¾¹å¤„ç†ã€‚ä¾‹å¦‚ï¼š åŠŸèƒ½å®ç°1. å·¥ç¨‹ç»“æ„123456789101112131415ai-rag-knowledge/â”œâ”€â”€ xfg-dev-tech-api/ # API æ¥å£å±‚â”‚ â””â”€â”€ IAiService.java # AI æœåŠ¡æ¥å£å®šä¹‰â”œâ”€â”€ xfg-dev-tech-app/ # åº”ç”¨å±‚â”‚ â”œâ”€â”€ Application.java # Spring Boot å¯åŠ¨ç±»â”‚ â”œâ”€â”€ config/ # é…ç½®ç±»â”‚ â”‚ â”œâ”€â”€ OllamaConfig.javaâ”‚ â”‚ â”œâ”€â”€ RedisClientConfig.javaâ”‚ â”‚ â””â”€â”€ RedisClientConfigProperties.javaâ”‚ â””â”€â”€ resources/ # é…ç½®æ–‡ä»¶â”‚ â”œâ”€â”€ application.ymlâ”‚ â”œâ”€â”€ application-dev.ymlâ”‚ â””â”€â”€ logback-spring.xmlâ””â”€â”€ xfg-dev-tech-trigger/ # è§¦å‘å™¨å±‚ â””â”€â”€ OllamaController.java # HTTP æ§åˆ¶å™¨ 2. ä¾èµ–ç®¡ç†å½“å‰æ­¥éª¤éœ€è¦ollamaçš„ä¾èµ–ï¼Œåœ¨appæ¨¡å—çš„POM.xmlæ–‡ä»¶æ·»åŠ ä¾èµ–ï¼š 1234&lt;dependency&gt; &lt;groupId&gt;org.springframework.ai&lt;/groupId&gt; &lt;artifactId&gt;spring-ai-ollama&lt;/artifactId&gt;&lt;/dependency&gt; 3. é…ç½®ç®¡ç†é…ç½®ä¿¡æ¯éœ€æ ¹æ®å¼€å‘ä¸éƒ¨ç½²ç¯å¢ƒçµæ´»è°ƒæ•´ã€‚å¼€å‘è¿‡ç¨‹ä¸­ï¼Œæˆ‘åœ¨ Windows PC ä¸Šè¿›è¡Œ Java å¼€å‘ï¼ŒOllama å’Œ DeepSeek éƒ¨ç½²äºäº‘æœåŠ¡å™¨çš„ Docker ç¯å¢ƒä¸­ï¼Œé…ç½®æ–‡ä»¶å¦‚ä¸‹æ‰€ç¤ºï¼š application.yml: 123456spring: application: name: ai-rag-knowledge profiles: active: dev application-dev.yml: 12345678910111213141516171819202122232425262728293031server: port: 8080spring: ai: ollama: # ä½¿ç”¨äº‘æœåŠ¡å™¨çš„ Ollama æœåŠ¡ï¼Œå°† IP æ›´æ¢ä¸ºä½ è‡ªå·±äº‘æœåŠ¡å™¨çš„å…¬ç½‘ IP # æœ¬åœ°éƒ¨ç½²çš„å°±æ”¹ä¸ºlocalhost:11434 base-url: http://&lt;éƒ¨ç½²äº†Ollamaçš„å…¬ç½‘IP&gt;:11434# Redis é…ç½®redis: sdk: config: host: localhost port: 6379 pool-size: 5 min-idle-size: 2 idle-timeout: 30000 connect-timeout: 5000 retry-attempts: 3 retry-interval: 1000 ping-interval: 60000 keep-alive: truelogging: level: root: debug cn.bugstack.xfg.dev.tech: debug config: classpath:logback-spring.xml å…¶ä»–é…ç½®æ–‡ä»¶æš‚ä¸”ä¸è€ƒè™‘ 4. ä»£ç å®ç°AIæœåŠ¡æ¥å£(IAiService.java)12345678910111213package cn.bugstack.xfg.dev.tech.api;import org.springframework.ai.chat.ChatResponse;import reactor.core.publisher.Flux;public interface IAiService &#123; ChatResponse generate(String model, String message); Flux&lt;ChatResponse&gt; generateStream(String model, String message);&#125; Ollama é…ç½®ç±» (OllamaConfig.java)12345678910111213141516171819202122package cn.bugstack.xfg.dev.tech.config;import org.springframework.ai.ollama.OllamaChatClient;import org.springframework.ai.ollama.api.OllamaApi;import org.springframework.beans.factory.annotation.Value;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;@Configurationpublic class OllamaConfig &#123; @Bean public OllamaApi ollamaApi(@Value(&quot;$&#123;spring.ai.ollama.base-url&#125;&quot;) String baseUrl) &#123; return new OllamaApi(baseUrl); &#125; @Bean public OllamaChatClient ollamaChatClient(OllamaApi ollamaApi) &#123; return new OllamaChatClient(ollamaApi); &#125;&#125; HTTP æ§åˆ¶å™¨ (OllamaController.java)123456789101112131415161718192021222324252627282930313233343536373839package cn.bugstack.xfg.dev.tech.trigger.http;import cn.bugstack.xfg.dev.tech.api.IAiService;import jakarta.annotation.Resource;import org.springframework.ai.chat.ChatResponse;import org.springframework.ai.chat.prompt.Prompt;import org.springframework.ai.ollama.OllamaChatClient;import org.springframework.ai.ollama.api.OllamaOptions;import org.springframework.web.bind.annotation.*;import reactor.core.publisher.Flux;@RestController()@CrossOrigin(&quot;*&quot;)@RequestMapping(&quot;/api/v1/ollama/&quot;)public class OllamaController implements IAiService &#123; @Resource private OllamaChatClient chatClient; /** * åŒæ­¥è°ƒç”¨æ¥å£ * curl http://localhost:8080/api/v1/ollama/generate?model=deepseek-r1:1.5b&amp;message=1+1 */ @RequestMapping(value = &quot;generate&quot;, method = RequestMethod.GET) @Override public ChatResponse generate(@RequestParam String model, @RequestParam String message) &#123; return chatClient.call(new Prompt(message, OllamaOptions.create().withModel(model))); &#125; /** * æµå¼è°ƒç”¨æ¥å£ * curl http://localhost:8080/api/v1/ollama/generate_stream?model=deepseek-r1:1.5b&amp;message=hi */ @RequestMapping(value = &quot;generate_stream&quot;, method = RequestMethod.GET) @Override public Flux&lt;ChatResponse&gt; generateStream(@RequestParam String model, @RequestParam String message) &#123; return chatClient.stream(new Prompt(message, OllamaOptions.create().withModel(model))); &#125;&#125; å¯åŠ¨ç±»12345678910111213141516package cn.bugstack.xfg.dev.tech;import org.springframework.beans.factory.annotation.Configurable;import org.springframework.boot.SpringApplication;import org.springframework.boot.autoconfigure.SpringBootApplication;@SpringBootApplication@Configurablepublic class Application &#123; public static void main(String[] args) &#123; SpringApplication.run(Application.class); &#125;&#125; åŠŸèƒ½æµ‹è¯•1. æ™®é€šè¯·æ±‚æµ‹è¯•å¯åŠ¨é¡¹ç›®ï¼Œç¡®ä¿äº‘æœåŠ¡å™¨çš„ollamaå·²ç»å¯åŠ¨åï¼Œæµè§ˆå™¨åœ°å€æ è¾“å…¥ï¼šhttp://localhost:8080/api/v1/ollama/generate?model=deepseek-r1:1.5b&amp;message=1+1ï¼Œå¾—åˆ°ç»“æœï¼š 2. æµå¼è¯·æ±‚æµ‹è¯•åœ°å€æ è¾“å…¥http://localhost:8080/api/v1/ollama/generate_stream?model=deepseek-r1:1.5b&amp;message=ä½ å¥½å•Š å°†æµå¼è¯·æ±‚çš„æ–‡æœ¬æ‹¼å‡‘å¾—åˆ°çš„å“åº”ç»“æœä¸ºï¼š 12345&lt;think&gt;&lt;/think&gt;ä½ å¥½ï¼å¾ˆé«˜å…´è§åˆ°ä½ ï¼Œæœ‰ä»€ä¹ˆæˆ‘å¯ä»¥å¸®å¿™çš„å—ï¼Ÿæ— è®ºæ˜¯é—®é¢˜ã€å»ºè®®è¿˜æ˜¯é—²èŠï¼Œæˆ‘éƒ½åœ¨è¿™å„¿å‘¢ï¼ğŸ˜Š å°ç»“æœ¬èŠ‚åŸºäº Spring AI å¯¹æ¥äº† Ollamaï¼ˆä»¥ DeepSeek æ¨¡å‹ä¸ºä¾‹ï¼‰ï¼Œåˆ†åˆ«å®ç°äº†æ™®é€šåº”ç­”ä¸æµå¼åº”ç­”ä¸¤ç±»æ¥å£ï¼š å¦‚æœä¸èƒ½å‡ºç°æœ€ç»ˆçš„å“åº”ç»“æœï¼Œè¯·ä¾æ¬¡æ£€æŸ¥ï¼š äº‘æœåŠ¡å™¨é˜²ç«å¢™æ˜¯å¦å¼€æ”¾11434ç«¯å£ äº‘æœåŠ¡å™¨ä¸­ollamaæ˜¯å¦æˆåŠŸè¿è¡Œ application-dev.ymlä¸­base-urlæ˜¯å¦æ›´æ”¹ä¸ºäº‘æœåŠ¡å™¨çš„å…¬ç½‘IP application-dev.ymlä¸­portæ˜¯å¦ä¸º8080","tags":[{"name":"é¡¹ç›®å­¦ä¹ ","slug":"é¡¹ç›®å­¦ä¹ ","permalink":"https://www.zhazhabear.site/tags/%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0/"},{"name":"åç«¯å¼€å‘","slug":"åç«¯å¼€å‘","permalink":"https://www.zhazhabear.site/tags/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/"}],"categories":[{"name":"AI Agentå­¦ä¹ ","slug":"AI-Agentå­¦ä¹ ","permalink":"https://www.zhazhabear.site/categories/AI-Agent%E5%AD%A6%E4%B9%A0/"}]},{"title":"äº‘æœåŠ¡å™¨é…ç½®","date":"2025-10-12T13:04:00.000Z","path":"2025/10/12/äº‘æœåŠ¡å™¨é…ç½®/","text":"æœ¬èŠ‚éœ€æ±‚ è´­ä¹°å¹¶åˆå§‹åŒ–äº‘æœåŠ¡å™¨ï¼Œå®Œæˆç«¯å£æ”¾é€šä¸ Docker&#x2F;Compose&#x2F;Portainer å®‰è£…ï¼Œä½¿ç”¨ docker compose éƒ¨ç½² AI Agent è¿è¡Œæ‰€éœ€çš„ç»„ä»¶ï¼ˆOllamaã€Redisã€å‘é‡åº“ï¼‰ï¼Œé…ç½® JDK 17 ä¸ Mavenï¼Œå¹¶æ‹‰å– DeepSeek R1 1.5B æ¨¡å‹å®Œæˆè”é€šéªŒè¯ã€‚ äº‘æœåŠ¡è¦æ±‚AI Agent è‡³å°‘éœ€è¦ 2C4G çš„äº‘æœåŠ¡å™¨ã€‚é˜¿é‡Œäº‘å­¦ç”Ÿä¼˜æƒ è·å–çš„2C2GæœåŠ¡å™¨æ— æ³•æ»¡è¶³æ€§èƒ½è¦æ±‚ï¼Œå› æ­¤å»ºè®®è´­ä¹°æ–°çš„å®ä¾‹ä»¥ä¿è¯æ¨¡å‹å’ŒæœåŠ¡çš„ç¨³å®šè¿è¡Œã€‚ è…¾è®¯äº‘ 4C4G å®ä¾‹ï¼ˆ79 å…ƒ&#x2F;å¹´ï¼‰ï¼Œæ€§ä»·æ¯”è¾ƒé«˜ã€‚å‚è€ƒï¼šè…¾è®¯äº‘æœåŠ¡å™¨4C4G é€‰æ‹©Ubuntu 24.04-LTSå³å¯ï¼Œä¸éœ€è¦é¢å¤–çš„åº”ç”¨é•œåƒ ç¯å¢ƒé…ç½®1. é‡ç½®å¯†ç  è¿™é‡Œéœ€è¦ç»™ root ç”¨æˆ·é‡ç½®å¯†ç ã€‚ 2. é˜²ç«å¢™å¼€æ”¾è‡³å°‘ç¡®ä¿ä¸‹åˆ—ç«¯å£çš„å¼€æ”¾ï¼š 3. Termius å®‰è£…Termius 4. Docker å®‰è£…1234567891011121314151617181920212223242526272829# ä¸‹è½½å¹¶è¿è¡Œå®˜æ–¹å®‰è£…è„šæœ¬curl -fsSL https://get.docker.com | sudo shsudo apt updatesudo apt install docker-compose-plugin -y# æ£€æŸ¥ Docker ç‰ˆæœ¬docker version# æ£€æŸ¥ Docker Compose ç‰ˆæœ¬docker compose version# åˆ›å»º Docker é…ç½®ç›®å½•sudo mkdir -p /etc/docker# é…ç½®é•œåƒåŠ é€Ÿå™¨ï¼ˆä½¿ç”¨è…¾è®¯äº‘å†…ç½‘é•œåƒï¼‰sudo tee /etc/docker/daemon.json &lt;&lt;EOF&#123; &quot;registry-mirrors&quot;: [ &quot;https://mirror.ccs.tencentyun.com&quot; ]&#125;EOF# é‡å¯ Dockersudo systemctl restart docker# æµ‹è¯•è¿è¡Œä¸€ä¸ªå®¹å™¨docker run hello-world å¦‚æœä¸Šè¿°è¿‡ç¨‹æ²¡æœ‰é—®é¢˜çš„è¯ï¼Œåˆ™ä¼šæ˜¾ç¤ºï¼š 5. AI-Agent ç¯å¢ƒé…ç½®åˆ›å»ºå¹¶åˆ‡æ¢åˆ° dev-ops ç›®å½•ï¼š 123cd /mkdir dev-opscd dev-ops å°†é¡¹ç›®ä¸­çš„ docs ç›®å½•ä¸‹çš„å†…å®¹ç§»åŠ¨è‡³äº‘æœåŠ¡å™¨çš„ dev-ops ç›®å½•ä¸‹ï¼ˆé€šè¿‡ Termius çš„ SFTPï¼‰ï¼š ç„¶åæ‰§è¡Œå¦‚ä¸‹å‘½ä»¤ï¼š 12# ä½¿ç”¨ docker composeï¼ˆæ³¨æ„ï¼šéƒ¨åˆ†è€å‘½ä»¤ä¸º docker-composeï¼‰docker compose -f docker-compose-environment-aliyun.yml up -d å³å¯å®Œæˆä¸‹åˆ—ç»„ä»¶çš„å®‰è£…å’Œé…ç½®ï¼š 1. Ollama - å¤§è¯­è¨€æ¨¡å‹æœåŠ¡ ä½œç”¨ï¼šè¿è¡Œæœ¬åœ°åŒ–çš„å¤§è¯­è¨€æ¨¡å‹ï¼ˆå¦‚ deepseek-r1:1.5bï¼‰ ç”¨é€”ï¼šæä¾›å¯¹è¯ AIã€æ–‡æœ¬ç”Ÿæˆã€ä»£ç è§£é‡Šç­‰ AI èƒ½åŠ› ç«¯å£ï¼š11434 - å¯ä»¥é€šè¿‡ API è°ƒç”¨æ¨¡å‹æœåŠ¡ 2. Redis - ç¼“å­˜å’Œæ¶ˆæ¯é˜Ÿåˆ— ä½œç”¨ï¼šé«˜é€Ÿå†…å­˜æ•°æ®åº“ï¼Œç”¨ä½œç¼“å­˜å’Œä¼šè¯å­˜å‚¨ ç”¨é€”ï¼šå­˜å‚¨ç”¨æˆ·ä¼šè¯ã€ç¼“å­˜ AI å“åº”ã€ä¸´æ—¶æ•°æ® ç®¡ç†ç•Œé¢ï¼šé€šè¿‡ redis-admin åœ¨ 8081 ç«¯å£å¯è§†åŒ–ç®¡ç† è´¦å¯†ï¼šadmin&#x2F;admin 3. Vector DB - å‘é‡æ•°æ®åº“ ä½œç”¨ï¼šä¸“é—¨å­˜å‚¨å’Œæ£€ç´¢å‘é‡æ•°æ®çš„æ•°æ®åº“ ç”¨é€”ï¼šå­˜å‚¨æ–‡æ¡£åµŒå…¥å‘é‡ï¼Œå®ç°è¯­ä¹‰æœç´¢ã€RAGï¼ˆæ£€ç´¢å¢å¼ºç”Ÿæˆï¼‰ æ•°æ®åº“ï¼šai-rag-knowledge æ¥ä¸‹æ¥éœ€è¦å®Œæˆ Mavenï¼ŒJDK 17 çš„é…ç½®ï¼š 1234567891011# 1. å®‰è£… JDK 17 å’Œ Mavensudo apt updatesudo apt install openjdk-17-jdk maven -y# 2. éªŒè¯å®‰è£…java -version # åº”è¯¥æ˜¾ç¤º JDK 17mvn -version # åº”è¯¥æ˜¾ç¤º Maven ç‰ˆæœ¬# 3. è®¾ç½® JAVA_HOMEecho &#x27;export JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64&#x27; &gt;&gt; ~/.bashrcsource ~/.bashrc 6. DeepSeek R1 1.5B æ¨¡å‹å®‰è£…1. å®‰è£… portainer12345678910docker volume create portainer_datadocker run -d \\ -p 9000:9000 \\ -p 9443:9443 \\ --name portainer \\ --restart always \\ -v /var/run/docker.sock:/var/run/docker.sock \\ -v portainer_data:/data \\ portainer/portainer-ce:latest é˜²ç«å¢™å¼€å¯ 9000 ç«¯å£ ç«‹å³è®¿é—®ï¼š&lt;å…¬ç½‘IP:9000&gt; è¿›å…¥ portainer ç•Œé¢ é¦–æ¬¡ç™»å½•éœ€è¦è®¾ç½®ç®¡ç†å‘˜è´¦å·çš„ç”¨æˆ·åå’Œå¯†ç  2. å®‰è£… Deepseek R1åœ¨ portainer ä¸­å®Œæˆå¦‚ä¸‹æ“ä½œï¼š ç„¶å Connectï¼Œä¾æ¬¡è¾“å…¥å¦‚ä¸‹å‘½ä»¤ï¼š 12345678# æ‹‰å–æ¨¡å‹ï¼Œæ¨èå°ä¸€ç‚¹ï¼Œå¤Ÿåšå¼€å‘å°±å¯ä»¥ollama pull deepseek-r1:1.5b# ï¼ˆå¯é€‰ï¼‰è¿è¡Œæ¨¡å‹ï¼Œè¿è¡Œåå…³é—­ï¼Œç»§ç»­å®‰è£…æ¨¡å‹ã€‚Ctrl/Command + Dollama run deepseek-r1:1.5b# å‘é‡æ–‡æœ¬ollama pull nomic-embed-text å‘½ä»¤æ‰§è¡Œå®Œæ¯•åï¼Œå³å¯ä¸ AI å¯¹è¯ï¼š è¾“å…¥ /exit é€€å‡ºå¯¹è¯ 3. é€šè¿‡å…¶ä»–é€”å¾„è®¿é—®1. å¯ä»¥åƒå°å‚…å“¥é¡¹ç›®ä¸­æåˆ°çš„ç”¨ sh è„šæœ¬ï¼š1234567curl http://&lt;ipv4åœ°å€&gt;:11434/api/generate \\ -H &quot;Content-Type: application/json&quot; \\ -d &#x27;&#123; &quot;model&quot;: &quot;deepseek-r1:1.5b&quot;, &quot;prompt&quot;: &quot;1+1&quot;, &quot;stream&quot;: false &#125;&#x27; 5. ä¹Ÿå¯ä»¥ç”¨ apifox å‘èµ·è¯·æ±‚ Body: 12345&#123; &quot;model&quot;: &quot;deepseek-r1:1.5b&quot;, &quot;prompt&quot;: &quot;ä½ å¥½&quot;, &quot;stream&quot;: false&#125; Headers: æˆåŠŸå“åº”ï¼","tags":[{"name":"é¡¹ç›®å­¦ä¹ ","slug":"é¡¹ç›®å­¦ä¹ ","permalink":"https://www.zhazhabear.site/tags/%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0/"},{"name":"Docker","slug":"Docker","permalink":"https://www.zhazhabear.site/tags/Docker/"},{"name":"Portainer","slug":"Portainer","permalink":"https://www.zhazhabear.site/tags/Portainer/"},{"name":"Ollama","slug":"Ollama","permalink":"https://www.zhazhabear.site/tags/Ollama/"},{"name":"Redis","slug":"Redis","permalink":"https://www.zhazhabear.site/tags/Redis/"},{"name":"è¿ç»´","slug":"è¿ç»´","permalink":"https://www.zhazhabear.site/tags/%E8%BF%90%E7%BB%B4/"}],"categories":[{"name":"AI Agentå­¦ä¹ ","slug":"AI-Agentå­¦ä¹ ","permalink":"https://www.zhazhabear.site/categories/AI-Agent%E5%AD%A6%E4%B9%A0/"}]},{"title":"å°å‹æ”¯ä»˜å•†åŸä¸‹å•æ”¯ä»˜","date":"2025-09-15T16:00:00.000Z","path":"2025/09/16/ä¸‹å•æ”¯ä»˜/","text":"å†…å®¹æ¦‚è¿°ä¸‹å•åŠŸèƒ½ä»¥åŠæ”¯ä»˜åŠŸèƒ½çš„å®Œæ•´å®ç° æµç¨‹å›¾ æµç¨‹åˆ†ægraph TB subgraph \"å‰ç«¯å±‚\" A[ç”¨æˆ·ç•Œé¢] --> B[HTTPè¯·æ±‚] end subgraph \"Webå±‚ (s-pay-mall-web)\" B --> C[AliPayController] C --> D[å‚æ•°éªŒè¯] end subgraph \"ä¸šåŠ¡å±‚ (s-pay-mall-service)\" D --> E[OrderServiceImpl] E --> F[ProductRPC] E --> G[æ”¯ä»˜å®SDK] end subgraph \"æ•°æ®å±‚ (s-pay-mall-dao)\" E --> H[IOrderDao] H --> I[(MySQLæ•°æ®åº“)] end subgraph \"å¤–éƒ¨ç³»ç»Ÿ\" G --> J[æ”¯ä»˜å®ç½‘å…³] J --> K[æ”¯ä»˜å›è°ƒ] K --> C end subgraph \"å¼‚æ­¥å¤„ç†\" E --> L[EventBusäº‹ä»¶æ€»çº¿] L --> M[OrderPaySuccessListener] N[å®šæ—¶ä»»åŠ¡] --> E end ç¬¬ä¸€é˜¶æ®µï¼šç”¨æˆ·ä¸‹å•è¯·æ±‚è¾“å…¥æ•°æ®ï¼š 12345POST /api/v1/alipay/create_pay_order&#123; &quot;userId&quot;: &quot;10001&quot;, &quot;productId&quot;: &quot;100001&quot;&#125; å¤„ç†æµç¨‹ï¼š å‰ç«¯å‘é€ HTTP POST è¯·æ±‚åˆ°AliPayController.createPayOrder() Controller æ¥æ”¶ ShopCartReq å¯¹è±¡ï¼ŒåŒ…å«ç”¨æˆ·IDå’Œå•†å“ID æ•°æ®æµå‘ï¼šå‰ç«¯è¯·æ±‚ -&gt; AliPayController -&gt; å‚æ•°éªŒè¯ ç¬¬äºŒé˜¶æ®µï¼šé‡å¤è®¢å•æ£€æŸ¥è¾“å…¥æ•°æ®ï¼šShopCartReqå¯¹è±¡ï¼š 1234public class ShopCartReq &#123; private String userId; private String productId;&#125; å¤„ç†æµç¨‹ï¼š OrderServiceImpl.createOrder() è¢«è°ƒç”¨ æ„é€ æŸ¥è¯¢æ¡ä»¶ï¼šåˆ›å»º PayOrder å¯¹è±¡è®¾ç½® userId å’Œ productId è°ƒç”¨ IOrderDao.queryUnPayOrder() æŸ¥è¯¢æ•°æ®åº“ 1234567891011121314public class PayOrder &#123; private Long id; private String userId; private String productId; private String productName; private String orderId; private Date orderTime; private BigDecimal totalAmount; private String status; private String payUrl; private Date payTime; private Date createTime; private Date updateTime;&#125; å¯èƒ½çš„æƒ…å†µï¼š è¿”å›çŠ¶æ€ä¸º PAY_WAIT çš„æœªæ”¯ä»˜è®¢å• ç›´æ¥è¿”å›ç°æœ‰çš„ PayOrderRes{orderId, payUrl} æµç¨‹ç»“æŸï¼Œè·³è½¬åˆ°è¿”å›å“åº”é˜¶æ®µ è¿”å›çŠ¶æ€ä¸º CREATE çš„è®¢å• éœ€è¦é‡æ–°åˆ›å»ºæ”¯ä»˜å• è°ƒç”¨ doPrepayOrder() æ–¹æ³•åˆ›å»ºæ”¯ä»˜å• è·³è½¬åˆ°æ”¯ä»˜å•åˆ›å»ºé˜¶æ®µ è¿”å› nullï¼ˆæ— ç›¸å…³è®¢å•ï¼‰ ç»§ç»­æ‰§è¡Œåç»­æµç¨‹ æ•°æ®æµå‘ï¼šOrderServiceImpl -&gt; IOrderDao -&gt; MySQLæ•°æ®åº“ -&gt; è¿”å›æŸ¥è¯¢ç»“æœ ç¬¬ä¸‰é˜¶æ®µï¼šå•†å“ä¿¡æ¯æŸ¥è¯¢è¾“å…¥æ•°æ®ï¼šproductIdï¼ˆString ç±»å‹ï¼‰ å¤„ç†æµç¨‹ï¼š è°ƒç”¨ ProductRPC.queryProductByProductId() è¿™æ˜¯ä¸€ä¸ªæ¨¡æ‹Ÿçš„RPCè°ƒç”¨ï¼Œå®é™…è¿”å›å›ºå®šçš„å•†å“ä¿¡æ¯ è¾“å‡ºæ•°æ®ï¼š 12345678910public class ProductVO &#123; /** å•†å“ID */ private String productId; /** å•†å“åç§° */ private String productName; /** å•†å“æè¿° */ private String productDesc; /** å•†å“ä»·æ ¼ */ private BigDecimal price;&#125; æ•°æ®æµå‘ï¼šOrderServiceImpl -&gt; ProductRPC -&gt; è¿”å›ProductVOå¯¹è±¡ ç¬¬å››é˜¶æ®µï¼šè®¢å•æ•°æ®æŒä¹…åŒ–è¾“å…¥æ•°æ®ï¼š userIdï¼šç”¨æˆ·ID productIdï¼šå•†å“ID productNameï¼šä»ProductVOè·å–çš„å•†å“åç§° priceï¼šä»ProductVOè·å–çš„å•†å“ä»·æ ¼ å¤„ç†æµç¨‹ï¼š ç”Ÿæˆ16ä½éšæœºè®¢å•å·ï¼šRandomStringUtils.randomNumeric(16) æ„é€  PayOrder å¯¹è±¡ï¼š 123456789PayOrder.builder() .userId(&quot;10001&quot;) .productId(&quot;100001&quot;) .productName(&quot;new product&quot;) .orderId(&quot;1234567890123456&quot;) // 16ä½éšæœºæ•° .totalAmount(new BigDecimal(&quot;1.68&quot;)) .orderTime(new Date()) .status(&quot;CREATE&quot;) // ä½¿ç”¨Constants.OrderStatusEnum.CREATE.getCode() .build() è°ƒç”¨ IOrderDao.insert() æ’å…¥æ•°æ®åº“ æ‰§è¡ŒSQLï¼šINSERT INTO pay_order(...) VALUES(...) è¾“å‡ºæ•°æ®ï¼š æ•°æ®åº“ä¸­æ–°å¢ä¸€æ¡è®¢å•è®°å½•ï¼ŒçŠ¶æ€ä¸º CREATE æ•°æ®æµå‘ï¼šOrderServiceImpl -&gt; æ„é€ PayOrderå¯¹è±¡ -&gt; IOrderDao -&gt; MySQLæ•°æ®åº“ ç¬¬äº”é˜¶æ®µï¼šæ”¯ä»˜å•åˆ›å»ºè¾“å…¥æ•°æ®ï¼š productIdï¼šå•†å“ID productNameï¼šå•†å“åç§° orderIdï¼šè®¢å•å· totalAmountï¼šè®¢å•é‡‘é¢ å¤„ç†æµç¨‹ï¼š è°ƒç”¨ doPrepayOrder() æ–¹æ³• åˆ›å»ºæ”¯ä»˜å®è¯·æ±‚å¯¹è±¡ï¼š 123AlipayTradePagePayRequest request = new AlipayTradePagePayRequest();request.setNotifyUrl(notifyUrl); // å¼‚æ­¥å›è°ƒåœ°å€request.setReturnUrl(returnUrl); // åŒæ­¥è·³è½¬åœ°å€ æ„é€ ä¸šåŠ¡å‚æ•°ï¼š 123456&#123; &quot;out_trade_no&quot;: &quot;1234567890123456&quot;, // å•†æˆ·è®¢å•å· &quot;total_amount&quot;: &quot;1.68&quot;, // è®¢å•é‡‘é¢ &quot;subject&quot;: &quot;new product&quot;, // è®¢å•æ ‡é¢˜ &quot;product_code&quot;: &quot;FAST_INSTANT_TRADE_PAY&quot;&#125; è°ƒç”¨æ”¯ä»˜å®SDKï¼šalipayClient.pageExecute(request).getBody() è¾“å‡ºæ•°æ®ï¼š æ”¯ä»˜å®è¿”å›HTMLè¡¨å•å­—ç¬¦ä¸²ï¼ŒåŒ…å«æ”¯ä»˜é¡µé¢çš„å®Œæ•´HTMLä»£ç  æ•°æ®æµå‘ï¼šOrderServiceImpl -&gt; æ„é€ æ”¯ä»˜å®è¯·æ±‚ -&gt; æ”¯ä»˜å®SDK -&gt; æ”¯ä»˜å®æœåŠ¡å™¨ -&gt; è¿”å›æ”¯ä»˜è¡¨å• ç¬¬å…­é˜¶æ®µï¼šæ›´æ–°è®¢å•æ”¯ä»˜ä¿¡æ¯è¾“å…¥æ•°æ®ï¼š orderIdï¼šè®¢å•å· payUrlï¼šæ”¯ä»˜å®è¿”å›çš„HTMLè¡¨å• statusï¼šæ–°çŠ¶æ€ PAY_WAIT å¤„ç†æµç¨‹ï¼š æ„é€ æ›´æ–°å¯¹è±¡ï¼š 1234PayOrder payOrder = new PayOrder();payOrder.setOrderId(&quot;1234567890123456&quot;);payOrder.setPayUrl(&quot;&lt;html&gt;æ”¯ä»˜è¡¨å•å†…å®¹&lt;/html&gt;&quot;);payOrder.setStatus(&quot;PAY_WAIT&quot;); è°ƒç”¨ IOrderDao.updateOrderPayInfo() æ‰§è¡ŒSQLï¼šUPDATE pay_order SET pay_url = ?, status = ?, update_time = now() WHERE order_id = ? è¾“å‡ºæ•°æ®ï¼š æ•°æ®åº“è®¢å•è®°å½•æ›´æ–°å®Œæˆï¼ŒçŠ¶æ€å˜ä¸º PAY_WAITï¼ŒåŒ…å«æ”¯ä»˜é“¾æ¥ æ•°æ®æµå‘ï¼šOrderServiceImpl -&gt; æ„é€ æ›´æ–°å¯¹è±¡ -&gt; IOrderDao -&gt; MySQLæ•°æ®åº“ ç¬¬ä¸ƒé˜¶æ®µï¼šè¿”å›æ”¯ä»˜å“åº”è¾“å…¥æ•°æ®ï¼š orderIdï¼šè®¢å•å· payUrlï¼šæ”¯ä»˜é“¾æ¥ å¤„ç†æµç¨‹ï¼š æ„é€ å“åº”å¯¹è±¡ï¼š 1234PayOrderRes.builder() .orderId(&quot;1234567890123456&quot;) .payUrl(&quot;&lt;html&gt;æ”¯ä»˜è¡¨å•&lt;/html&gt;&quot;) .build() åœ¨Controllerå±‚åŒ…è£…æˆç»Ÿä¸€å“åº”æ ¼å¼ï¼š 12345Response.&lt;String&gt;builder() .code(&quot;0000&quot;) // Constants.ResponseCode.SUCCESS.getCode() .info(&quot;è°ƒç”¨æˆåŠŸ&quot;) // Constants.ResponseCode.SUCCESS.getInfo() .data(payOrderRes.getPayUrl()) .build() è®°å½•æˆåŠŸæ—¥å¿—ï¼šâ€å•†å“ä¸‹å•ï¼Œæ ¹æ®å•†å“IDåˆ›å»ºæ”¯ä»˜å•å®Œæˆâ€ è¾“å‡ºæ•°æ®ï¼ˆè¿”å›ç»™å‰ç«¯ï¼‰ï¼š 12345&#123; &quot;code&quot;: &quot;0000&quot;, &quot;info&quot;: &quot;è°ƒç”¨æˆåŠŸ&quot;, &quot;data&quot;: &quot;&lt;html&gt;æ”¯ä»˜å®æ”¯ä»˜è¡¨å•HTMLä»£ç &lt;/html&gt;&quot;&#125; æ•°æ®æµå‘ï¼šOrderServiceImpl -&gt; PayOrderRes -&gt; AliPayController -&gt; Responseå¯¹è±¡ -&gt; å‰ç«¯é¡µé¢ ç¬¬å…«é˜¶æ®µï¼šç”¨æˆ·æ”¯ä»˜æ“ä½œå¤„ç†æµç¨‹ï¼š å‰ç«¯æ¥æ”¶åˆ°æ”¯ä»˜è¡¨å•HTML ç”¨æˆ·æµè§ˆå™¨æ¸²æŸ“æ”¯ä»˜é¡µé¢ ç”¨æˆ·åœ¨æ”¯ä»˜å®é¡µé¢å®Œæˆä»˜æ¬¾æ“ä½œ æ”¯ä»˜å®å¤„ç†æ”¯ä»˜è¯·æ±‚å¹¶æ‰£æ¬¾ æ•°æ®æµå‘ï¼šå‰ç«¯é¡µé¢ -&gt; ç”¨æˆ·æ“ä½œ -&gt; æ”¯ä»˜å®æ”¯ä»˜é¡µé¢ -&gt; æ”¯ä»˜å®æœåŠ¡å™¨å¤„ç† ç¬¬ä¹é˜¶æ®µï¼šæ”¯ä»˜å›è°ƒå¤„ç†è¾“å…¥æ•°æ®ï¼ˆæ”¯ä»˜å®å¼‚æ­¥å›è°ƒï¼‰ï¼š 1POST /api/v1/alipay/pay_notify å‚æ•°åŒ…æ‹¬ï¼š trade_status: â€œTRADE_SUCCESSâ€ out_trade_no: â€œ1234567890123456â€ (å•†æˆ·è®¢å•å·) trade_no: â€œ2021081622001234567890123456â€ (æ”¯ä»˜å®äº¤æ˜“å·) total_amount: â€œ1.68â€ sign: â€œæ”¯ä»˜å®RSA256ç­¾åâ€ å…¶ä»–æ”¯ä»˜å®å›è°ƒå‚æ•°â€¦ å¤„ç†æµç¨‹ï¼š AliPayController.payNotify() æ¥æ”¶å›è°ƒ äº¤æ˜“çŠ¶æ€éªŒè¯ï¼šæ£€æŸ¥ trade_status æ˜¯å¦ä¸º â€œTRADE_SUCCESSâ€ ç­¾åéªŒè¯ï¼š 123String sign = params.get(&quot;sign&quot;);String content = AlipaySignature.getSignCheckContentV1(params);boolean checkSignature = AlipaySignature.rsa256CheckContent(content, sign, alipayPublicKey, &quot;UTF-8&quot;); è®°å½•å›è°ƒæ—¥å¿—ï¼šè®°å½•äº¤æ˜“åç§°ã€çŠ¶æ€ã€æ”¯ä»˜å®äº¤æ˜“å·ã€é‡‘é¢ç­‰ä¿¡æ¯ éªŒè¯å¤±è´¥çš„è¾“å‡ºï¼š è¿”å›å­—ç¬¦ä¸² â€œfalseâ€ ç»™æ”¯ä»˜å®ï¼ˆæ‹’ç»å›è°ƒï¼‰ éªŒè¯æˆåŠŸç»§ç»­å¤„ç†â€¦ æ•°æ®æµå‘ï¼šæ”¯ä»˜å®æœåŠ¡å™¨ -&gt; AliPayController.payNotify() -&gt; å‚æ•°è§£æå’ŒéªŒè¯ ç¬¬åé˜¶æ®µï¼šè®¢å•çŠ¶æ€æ›´æ–°è¾“å…¥æ•°æ®ï¼š orderIdï¼šä»å›è°ƒå‚æ•° out_trade_no è·å– å¤„ç†æµç¨‹ï¼š è°ƒç”¨ OrderServiceImpl.changeOrderPaySuccess() æ„é€ æ›´æ–°å¯¹è±¡ï¼š 123PayOrder payOrderReq = new PayOrder();payOrderReq.setOrderId(&quot;1234567890123456&quot;);payOrderReq.setStatus(&quot;PAY_SUCCESS&quot;); // Constants.OrderStatusEnum.PAY_SUCCESS.getCode() è°ƒç”¨ IOrderDao.changeOrderPaySuccess() æ‰§è¡ŒSQLï¼šUPDATE pay_order SET status = ?, pay_time = now(), update_time = now() WHERE order_id = ? è¾“å‡ºæ•°æ®ï¼š æ•°æ®åº“è®¢å•çŠ¶æ€æ›´æ–°ä¸º PAY_SUCCESS è®¾ç½®æ”¯ä»˜æ—¶é—´ä¸ºå½“å‰æ—¶é—´ æ•°æ®æµå‘ï¼šOrderServiceImpl -&gt; æ„é€ æ›´æ–°å¯¹è±¡ -&gt; IOrderDao -&gt; MySQLæ•°æ®åº“ ç¬¬åä¸€é˜¶æ®µï¼šå¼‚æ­¥äº‹ä»¶å‘å¸ƒè¾“å…¥æ•°æ®ï¼š æ›´æ–°åçš„ PayOrder å¯¹è±¡ å¤„ç†æµç¨‹ï¼š å°†è®¢å•å¯¹è±¡åºåˆ—åŒ–ä¸ºJSONï¼šJSON.toJSONString(payOrderReq) é€šè¿‡EventBuså‘å¸ƒäº‹ä»¶ï¼ševentBus.post(jsonString) OrderPaySuccessListener.handleEvent() ç›‘å¬å¹¶å¤„ç†äº‹ä»¶ è¾“å‡ºæ•°æ®ï¼š 123456&#123; &quot;orderId&quot;: &quot;1234567890123456&quot;, &quot;status&quot;: &quot;PAY_SUCCESS&quot;, &quot;payTime&quot;: &quot;2025-09-16 10:30:00&quot;, &quot;updateTime&quot;: &quot;2025-09-16 10:30:00&quot;&#125; åç»­å¤„ç†ï¼š å•†å“å‘è´§é€»è¾‘ ç§¯åˆ†å¥–åŠ±è®¡ç®— ç”¨æˆ·é€šçŸ¥æ¨é€ è¿”åˆ©å¤„ç†ç­‰ æ•°æ®æµå‘ï¼šOrderServiceImpl -&gt; EventBus -&gt; OrderPaySuccessListener -&gt; åç»­ä¸šåŠ¡å¤„ç† ç¬¬åäºŒé˜¶æ®µï¼šå›è°ƒå“åº”è¿”å›è¾“å‡ºæ•°æ®ï¼š å‘æ”¯ä»˜å®è¿”å›å­—ç¬¦ä¸² â€œsuccessâ€ï¼ˆè¡¨ç¤ºå›è°ƒå¤„ç†æˆåŠŸï¼‰ è®°å½•æ—¥å¿—ï¼šâ€æ”¯ä»˜å›è°ƒï¼Œæ”¯ä»˜å›è°ƒï¼Œæ›´æ–°è®¢å• {}â€ æ•°æ®æµå‘ï¼šAliPayController -&gt; æ”¯ä»˜å®æœåŠ¡å™¨ï¼ˆç¡®è®¤å›è°ƒå¤„ç†å®Œæˆï¼‰ å¼‚æ­¥å¤„ç†æœºåˆ¶å®šæ—¶ä»»åŠ¡å¤„ç†è¶…æ—¶å…³å•ï¼š TimeoutCloseOrderJob æ¯10åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ æŸ¥è¯¢è¶…è¿‡30åˆ†é’Ÿæœªæ”¯ä»˜çš„è®¢å•ï¼šqueryTimeoutCloseOrderList() å°†è®¢å•çŠ¶æ€æ›´æ–°ä¸º CLOSE æ”¯ä»˜çŠ¶æ€ä¸»åŠ¨æŸ¥è¯¢ï¼š NoPayNotifyOrderJob æ¯3ç§’æ‰§è¡Œä¸€æ¬¡ æŸ¥è¯¢è¶…è¿‡1åˆ†é’Ÿæœªæ”¯ä»˜ä¸”æœªæ”¶åˆ°å›è°ƒçš„è®¢å•ï¼šqueryNoPayNotifyOrder() ä¸»åŠ¨è°ƒç”¨æ”¯ä»˜å®æ¥å£æŸ¥è¯¢è®¢å•å®é™…æ”¯ä»˜çŠ¶æ€ è‹¥æ”¯ä»˜æˆåŠŸåˆ™æ›´æ–°è®¢å•çŠ¶æ€ä¸º PAY_SUCCESS äº‹ä»¶ç›‘å¬å™¨æ”¯ä»˜æˆåŠŸäº‹ä»¶ç›‘å¬ï¼š OrderPaySuccessListener åŸºäºGuava EventBuså®ç° é€šè¿‡@Subscribeæ³¨è§£è®¢é˜…æ”¯ä»˜æˆåŠŸäº‹ä»¶ æ¥æ”¶JSONæ ¼å¼çš„è®¢å•ä¿¡æ¯ è´Ÿè´£å¤„ç†æ”¯ä»˜æˆåŠŸåçš„å¼‚æ­¥ä¸šåŠ¡é€»è¾‘ï¼ˆå¦‚å•†å“å‘è´§ã€ç§¯åˆ†å¥–åŠ±ç­‰ï¼‰","tags":[{"name":"é¡¹ç›®å­¦ä¹ ","slug":"é¡¹ç›®å­¦ä¹ ","permalink":"https://www.zhazhabear.site/tags/%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0/"},{"name":"æ”¯ä»˜å®æ²™ç®±","slug":"æ”¯ä»˜å®æ²™ç®±","permalink":"https://www.zhazhabear.site/tags/%E6%94%AF%E4%BB%98%E5%AE%9D%E6%B2%99%E7%AE%B1/"},{"name":"åç«¯å¼€å‘","slug":"åç«¯å¼€å‘","permalink":"https://www.zhazhabear.site/tags/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/"}],"categories":[{"name":"å°å‹æ”¯ä»˜å•†åŸå­¦ä¹ ","slug":"å°å‹æ”¯ä»˜å•†åŸå­¦ä¹ ","permalink":"https://www.zhazhabear.site/categories/%E5%B0%8F%E5%9E%8B%E6%94%AF%E4%BB%98%E5%95%86%E5%9F%8E%E5%AD%A6%E4%B9%A0/"}]},{"title":"å°å‹æ”¯ä»˜å•†åŸå‰æœŸå‡†å¤‡","date":"2025-09-06T16:00:00.000Z","path":"2025/09/07/å‰æœŸå‡†å¤‡/","text":"æ³¨æ„ï¼šè¯¥é¡¹ç›®åŸºäºjdk1.8 (java8)ï¼ŒåŠ¡å¿…ç¡®è®¤é¡¹ç›®çš„jdkç‰ˆæœ¬ å†…å®¹æ¦‚è¿°å°å‚…å“¥é¡¹ç›®7-11é›†çš„å†…å®¹ï¼ŒåŒ…å«ç±»è®¾è®¡ä¸æµç¨‹åˆ†æ 1.1. Natapp å†…ç½‘ç©¿é€å†…ç½‘ç©¿é€æ•™ç¨‹ æ³¨æ„äº‹é¡¹ï¼šWindowsç«¯natappæ–‡ä»¶å¤¹å†…ä¸€å®šè¦æœ‰natapp.exeï¼Œä¸‹å›¾ä¸­æ²¡æœ‰åç¼€çš„ç‰ˆæœ¬æ— æ³•è¿è¡Œ 1.2. å¾®ä¿¡å…¬ä¼—å·æµ‹è¯•å¹³å°å¾®ä¿¡å…¬ä¼—å·æµ‹è¯•å¹³å°ç”³è¯·æ•™ç¨‹å¯¹æ¥å·¥ç¨‹é¡¹ç›®åœ°å€ 1.3. æ”¯ä»˜å®æ²™ç®±æ”¯ä»˜å®æ²™ç®±ç”³è¯·ä½¿ç”¨æ•™ç¨‹ ç›´æ¥çœ‹å¥½åƒå¹¶æ²¡æœ‰æ‰¾åˆ°â€œæ²™ç®±â€é€‰é¡¹ï¼Œå¾€ä¸‹æ»‘åŠ¨ï¼Œå³å¯çœ‹åˆ°â€œæ²™ç®±â€ 2.1 MVC å·¥ç¨‹æ¡†æ¶æ­å»º + åŸºç¡€é…ç½® + Git ä½¿ç”¨1. æ–°å»ºé¡¹ç›®ä½¿ç”¨IDEAæ–°å»ºSpring Booté¡¹ç›®ï¼Œå‘ç°æ²¡æœ‰Java 8çš„é€‰é¡¹ã€‚åŸå› å¯ä»¥å‚è€ƒè¿™ç¯‡åšå®¢è§£å†³IDEAåˆ›å»ºSpringBooté¡¹ç›®æ²¡æœ‰Javaç‰ˆæœ¬8 çœæµè§£å†³æ–¹æ¡ˆï¼šå°†æœ€ä¸Šæ–¹æœåŠ¡å™¨URLæ”¹ä¸ºstart.aliyun.comå³å¯è§£å†³é—®é¢˜ å…¶ä»–è¿‡ç¨‹ç•¥è¿‡ï¼Œå¦‚æœè§‰å¾—ä¸Šè¿°è¿‡ç¨‹éº»çƒ¦çš„è¯ï¼Œä¹Ÿå¯ä»¥ç›´æ¥cloneä»“åº“s-pay-mall-mvc æ³¨æ„ï¼šä¸è¦ç›´æ¥åœ¨ideaä¸­é€šè¿‡ç‰ˆæœ¬æ§åˆ¶æ–°å»ºé¡¹ç›® åº”è¯¥ç”¨å‘½ä»¤è¡Œgit clone &lt;é“¾æ¥&gt;çš„æ–¹å¼cloneï¼Œç„¶åç”¨ideaæ‰“å¼€æ–‡ä»¶å¤¹ ç„¶åç”¨gitå°†é¡¹ç›®è¿˜åŸå›å†å²ç‰ˆæœ¬ï¼š 2.2 å¾®ä¿¡å…¬ä¼—å·é‰´æƒ æœ¬èŠ‚å†…å®¹ï¼šåœ¨ mvc åˆ†å±‚æ¡†æ¶ç»“æ„ä¸‹æ·»åŠ å¾®ä¿¡å…¬ä¼—å·é‰´æƒæ‰€éœ€çš„æ¥å£ï¼Œå¹¶é€šè¿‡ natapp å†…ç½‘ç©¿é€ç»„ä»¶ï¼Œæš´æ¼æœ¬åœ°æ¥å£ï¼Œè®©å¾®ä¿¡å…¬ä¼—å·å¹³å°å¯ä»¥é…ç½®ä½¿ç”¨ã€‚ 1. commonæ¨¡å—éƒ¨åˆ† MessageTextEntity.javaå¾®ä¿¡æ¶ˆæ¯å®ä½“ç±» ä¸¥æ ¼æŒ‰ç…§å¾®ä¿¡å…¬ä¼—å¹³å°æ¶ˆæ¯æ ¼å¼è§„èŒƒå®ç° ä¸»è¦ç”¨é€” ï¼šå°è£…å¾®ä¿¡å…¬ä¼—å·æ¶ˆæ¯çš„æ•°æ®ç»“æ„ï¼Œæ”¯æŒXMLä¸Javaå¯¹è±¡çš„ç›¸äº’è½¬æ¢ å…³é”®ç‰¹æ€§ ï¼š ä½¿ç”¨@XStreamAliasæ³¨è§£æ˜ å°„å¾®ä¿¡æ¶ˆæ¯çš„XMLæ ‡ç­¾ åŒ…å«å¾®ä¿¡æ¶ˆæ¯çš„æ ‡å‡†å­—æ®µï¼šToUserNameã€FromUserNameã€CreateTimeã€ MsgTypeã€Eventã€EventKeyç­‰ æ”¯æŒæ–‡æœ¬æ¶ˆæ¯å’Œäº‹ä»¶æ¶ˆæ¯çš„æ•°æ®ç»“æ„ å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯æ–‡æ¡£ åœ¨ä¸Šé¢7ä¸ªå­—æ®µçš„åŸºç¡€ä¸ŠåŠ ä¸Šç”Ÿæˆå¸¦å‚çš„äºŒç»´ç æ‰€éœ€è¦çš„ticketå­—æ®µï¼Œæ„æˆäº†MessageTextEntity å…³äº@XStreamAliasæ³¨è§£ SignatureUtil.javaå¾®ä¿¡ç­¾åéªŒè¯å·¥å…· æŒ‰ç…§å¾®ä¿¡å…¬ä¼—å¹³å°æä¾›çš„ç­¾åç®—æ³•å®ç° ä¸»è¦ç”¨é€” ï¼šéªŒè¯è¯·æ±‚æ˜¯å¦æ¥æºäºå¾®ä¿¡æœåŠ¡å™¨ï¼Œç¡®ä¿é€šä¿¡å®‰å…¨ å…³é”®ç‰¹æ€§ ï¼š å®ç°äº†å¾®ä¿¡è¦æ±‚çš„SHA-1åŠ å¯†ç®—æ³• åŒ…å«å­—å…¸åºæ’åºã€å­—èŠ‚æ•°ç»„è½¬åå…­è¿›åˆ¶å­—ç¬¦ä¸²ç­‰è¾…åŠ©æ–¹æ³• æä¾› check æ–¹æ³•è¿›è¡Œç­¾åéªŒè¯ ä»€ä¹ˆæ—¶å€™å¾®ä¿¡æœåŠ¡å™¨ä¼šå¾€ä½ çš„æœåŠ¡å™¨å‘è¯·æ±‚ï¼Ÿ å½“æ‚¨åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°ï¼ˆå…¬ä¼—å·æˆ–å°ç¨‹åºï¼‰çš„åå°é…ç½®äº†â€œæœåŠ¡å™¨åœ°å€â€ï¼ˆURLï¼‰å¹¶å¯ç”¨åï¼Œä»¥ä¸‹å‡ ç§å…¸å‹åœºæ™¯ä¸‹ï¼Œå¾®ä¿¡æœåŠ¡å™¨éƒ½ä¼šå‘æ‚¨çš„æœåŠ¡å™¨å‘é€è¯·æ±‚ï¼š é¦–æ¬¡éªŒè¯æœåŠ¡å™¨ åœºæ™¯ï¼šæ‚¨åœ¨åå°æäº¤æ‚¨çš„æœåŠ¡å™¨åœ°å€å’ŒTokenæ—¶ï¼Œå¾®ä¿¡ä¼šç«‹å³å‘è¯¥åœ°å€å‘é€ä¸€ä¸ªGETè¯·æ±‚ï¼ŒåŒ…å«signature, timestamp, nonce, echostrå‚æ•°ã€‚ ç›®çš„ï¼šå°±æ˜¯ä¸ºäº†éªŒè¯â€œæ‚¨æä¾›çš„è¿™ä¸ªURLèƒŒåç¡®å®æ˜¯ä¸€ä¸ªæœ‰æ•ˆçš„ã€ç†è§£å¾®ä¿¡åè®®çš„æœåŠ¡â€ã€‚æ‚¨æœåŠ¡å™¨ä¸Šçš„SignatureUtil.check()æ–¹æ³•å°±æ˜¯ç”¨æ¥å¤„ç†è¿™ä¸ªè¯·æ±‚çš„ã€‚éªŒè¯é€šè¿‡åï¼Œæ‚¨éœ€è¦å°†æ¥æ”¶åˆ°çš„echostrå‚æ•°åŸæ ·è¿”å›ç»™å¾®ä¿¡ã€‚è¿™æ ·ï¼Œå¾®ä¿¡æ‰ç›¸ä¿¡æ‚¨æ‹¥æœ‰è¿™ä¸ªæœåŠ¡å™¨ï¼Œåç»­æ‰ä¼šæŠŠé‡è¦æ¶ˆæ¯æ¨é€ç»™æ‚¨ã€‚ æ¥æ”¶ç”¨æˆ·æ¶ˆæ¯ï¼ˆæ¶ˆæ¯æ¨é€ï¼‰ åœºæ™¯ï¼šå½“ç”¨æˆ·åœ¨æ‚¨çš„å…¬ä¼—å·é‡Œå‘é€æ–‡å­—ã€å›¾ç‰‡ã€è¯­éŸ³ã€ä½ç½®ç­‰æ¶ˆæ¯æ—¶ï¼Œå¾®ä¿¡æœåŠ¡å™¨ä¼šå°†è¿™äº›æ¶ˆæ¯æ‰“åŒ…æˆä¸€ä¸ªXMLæ ¼å¼çš„POSTè¯·æ±‚ï¼Œå‘é€åˆ°æ‚¨çš„æœåŠ¡å™¨ã€‚ ç›®çš„ï¼šè®©æ‚¨çš„æœåŠ¡å™¨èƒ½å¤Ÿå¤„ç†ç”¨æˆ·æ¶ˆæ¯ï¼Œå®ç°è‡ªåŠ¨å›å¤ã€å®¢æœç­‰åŠŸèƒ½ã€‚åœ¨å¤„ç†è¿™äº›POSTè¯·æ±‚ä¹‹å‰ï¼ŒåŒæ ·éœ€è¦å…ˆç”¨SignatureUtil.check()éªŒè¯è¿™ä¸ªPOSTè¯·æ±‚ç¡®å®æ¥è‡ªå¾®ä¿¡ï¼Œè€Œä¸æ˜¯é»‘å®¢ä¼ªé€ çš„ã€‚ æ¥æ”¶äº‹ä»¶æ¨é€ï¼ˆäº‹ä»¶æ¨é€ï¼‰ åœºæ™¯ï¼šå½“å‘ç”ŸæŸäº›äº‹ä»¶æ—¶ï¼Œå¾®ä¿¡ä¹Ÿä¼šé€šçŸ¥æ‚¨çš„æœåŠ¡å™¨ã€‚ä¾‹å¦‚ï¼š å…³æ³¨&#x2F;å–å…³ï¼šç”¨æˆ·å…³æ³¨æ‚¨çš„å…¬ä¼—å·æˆ–å–æ¶ˆå…³æ³¨ã€‚ èœå•ç‚¹å‡»ï¼šç”¨æˆ·ç‚¹å‡»äº†æ‚¨è‡ªå®šä¹‰çš„èœå•æŒ‰é’®ã€‚ æ”¯ä»˜æˆåŠŸï¼šç”¨æˆ·åœ¨å°ç¨‹åºæˆ–å…¬ä¼—å·å†…å®Œæˆäº†æ”¯ä»˜ã€‚ æ¨¡æ¿æ¶ˆæ¯å‘é€ç»“æœï¼šæ‚¨å‘é€çš„æ¨¡æ¿æ¶ˆæ¯æ˜¯å¦æˆåŠŸé€è¾¾ã€‚ ç›®çš„ï¼šè®©æ‚¨çš„æœåŠ¡å™¨èƒ½å¤Ÿå“åº”è¿™äº›é‡è¦äº‹ä»¶ï¼Œæ›´æ–°ç”¨æˆ·çŠ¶æ€ã€è§¦å‘ç§¯åˆ†å‘æ”¾ã€æ›´æ–°è®¢å•çŠ¶æ€ç­‰ã€‚åŒæ ·ï¼Œè¿™äº›è¯·æ±‚ä¹Ÿéœ€è¦éªŒè¯ç­¾åã€‚ XmlUtil.javaXMLæ•°æ®å¤„ç†å·¥å…·ç±» æ ¹æ®å¾®ä¿¡å…¬ä¼—å¹³å°å¯¹XMLæ¶ˆæ¯æ ¼å¼çš„è¦æ±‚å®ç° ä¸»è¦ç”¨é€”ï¼šå¤„ç†ä¸å¾®ä¿¡æœåŠ¡å™¨ä¹‹é—´çš„XMLæ•°æ®äº¤äº’ å…³é”®ç‰¹æ€§ ï¼š æä¾› xmlToMap æ–¹æ³•è§£æå¾®ä¿¡è¯·æ±‚XML æä¾› mapToXML æ–¹æ³•æ„å»ºå“åº”XML æä¾› beanToXml å’Œ xmlToBean æ–¹æ³•å®ç°å¯¹è±¡ä¸XMLçš„ç›¸äº’è½¬æ¢ ä½¿ç”¨XStreamå’Œdom4jåº“è¿›è¡ŒXMLå¤„ç† æ”¯æŒCDATAæ ‡è®°çš„æ·»åŠ ï¼Œç¬¦åˆå¾®ä¿¡æ¶ˆæ¯è§„èŒƒ 2. webæ¨¡å—éƒ¨åˆ†WeixinPortalController å¾®ä¿¡å…¬ä¼—å·åå°æ¥å£æ§åˆ¶å™¨ï¼Œä¸»è¦ç”¨äºä¸å¾®ä¿¡æœåŠ¡å™¨è¿›è¡Œå¯¹æ¥ï¼Œå¤„ç†å¾®ä¿¡å…¬ä¼—å·çš„æ¶ˆæ¯æ¥æ”¶å’Œäº‹ä»¶å“åº”ã€‚ åŒæ—¶éœ€è¦åœ¨resources/application-dev.ymlä¸‹ä¿®æ”¹é…ç½®ï¼š 12345# å¾®ä¿¡å…¬ä¼—å·å¯¹æ¥weixin: config: originalid: #å¡«å†™ä½ çš„originalid token: #å¡«å†™ä½ çš„token å¦‚æœé‡åˆ°natappæ˜¾ç¤ºç¦»çº¿çŠ¶æ€çš„æƒ…å†µï¼Œä¹Ÿè¦åœ¨webåŒ…ä¸‹çš„resources/application-dev.ymlå°†portä¿®æ”¹ä¸º8080","tags":[{"name":"é¡¹ç›®å­¦ä¹ ","slug":"é¡¹ç›®å­¦ä¹ ","permalink":"https://www.zhazhabear.site/tags/%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0/"},{"name":"åç«¯å¼€å‘","slug":"åç«¯å¼€å‘","permalink":"https://www.zhazhabear.site/tags/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/"},{"name":"Natapp","slug":"Natapp","permalink":"https://www.zhazhabear.site/tags/Natapp/"}],"categories":[{"name":"å°å‹æ”¯ä»˜å•†åŸå­¦ä¹ ","slug":"å°å‹æ”¯ä»˜å•†åŸå­¦ä¹ ","permalink":"https://www.zhazhabear.site/categories/%E5%B0%8F%E5%9E%8B%E6%94%AF%E4%BB%98%E5%95%86%E5%9F%8E%E5%AD%A6%E4%B9%A0/"}]},{"title":"å°å‹æ”¯ä»˜å•†åŸç™»å½•åŠŸèƒ½","date":"2025-09-06T16:00:00.000Z","path":"2025/09/07/ç™»å½•åŠŸèƒ½/","text":"å†…å®¹æ¦‚è¿°ç™»å½•åŠŸèƒ½è®¾è®¡å®ç°ï¼Œä»¥åŠæ¶‰åŠåˆ°çš„ç±»è®¾è®¡ä¸æµç¨‹åˆ†æ æµç¨‹åˆ†æ å°å‚…å“¥ç‰ˆæœ¬æµç¨‹å›¾ï¼š ç®€ç•¥ç‰ˆæœ¬æµç¨‹å›¾ï¼š æ ¸å¿ƒæµç¨‹ï¼š ç”¨æˆ·ç‚¹å‡»ç™»å½•ï¼Œæµè§ˆå™¨å‘æœåŠ¡å™¨è¯·æ±‚ticket æœåŠ¡å™¨æ£€æµ‹æ˜¯å¦ç¼“å­˜æœ‰æœ‰æ•ˆçš„access tokenï¼Œå¦‚æœæ²¡æœ‰åˆ™å‘å¾®ä¿¡æœåŠ¡å™¨è¯·æ±‚(è¯·æ±‚éœ€è¦appidå’Œsecretä¸¤ä¸ªå‚æ•°ï¼Œè¿™ä¸¤ä¸ªå‚æ•°åœ¨å¾®ä¿¡å…¬ä¼—å¹³å°å¯ä»¥æŸ¥çœ‹)(ç”Ÿæˆaccess tokenï¼šhttps://developers.weixin.qq.com/doc/service/guide/dev/api/#%E7%94%9F%E6%88%90-Access-Token) æœåŠ¡å™¨ä½¿ç”¨access tokenä½œä¸ºå‚æ•°è°ƒç”¨å¾®ä¿¡æœåŠ¡å™¨çš„API å¾®ä¿¡æœåŠ¡å™¨è¿”å›ticketè‡³æœåŠ¡å™¨ æœåŠ¡å™¨å°†ticketä¼ å›ç»™æµè§ˆå™¨ æµè§ˆå™¨é€šè¿‡ticketæ‹¼æ¥å‡ºå›¾ç‰‡URL(https://mp.weixin.qq.com/cgi-bin/showqrcode?ticket=xxx) ï¼Œå¹¶æ˜¾ç¤ºäºŒç»´ç  ç”¨æˆ·æ‰«æç½‘é¡µçš„äºŒç»´ç  å¾®ä¿¡æœåŠ¡å™¨å›è°ƒé…ç½®å¥½çš„å›è°ƒåœ°å€ï¼Œé€šçŸ¥æ‰«ç äº‹ä»¶ï¼Œå¹¶åœ¨è¯·æ±‚ä¸­æºå¸¦ticketä¸æ‰«ç ç”¨æˆ·çš„openid æµè§ˆå™¨æŒç»­å‘æœåŠ¡å™¨æŸ¥è¯¢ç™»å½•çŠ¶æ€ï¼Œå‚æ•°ä¸ºticket æœåŠ¡å™¨æ”¶åˆ°è½®è¯¢åå¦‚æœå‘ç°ticketå·²ç»ç»‘å®šäº†openidï¼Œåˆ™ç”Ÿæˆtokenå¹¶è¿”å›ç»™æµè§ˆå™¨ä½œä¸ºç™»å½•å‡­è¯ 1. ç”¨æˆ·ç‚¹å‡»ç™»å½•ï¼Œæµè§ˆå™¨å‘æœåŠ¡å™¨è¯·æ±‚ticket12345678fetch(&#x27;http://localhost:8091/api/v1/login/weixin_qrcode_ticket&#x27;) .then(response =&gt; response.json()) .then(data =&gt; &#123; if (data.code === &quot;0000&quot;) &#123; const ticket = data.data; // ... &#125; &#125;) 2-5. æœåŠ¡å™¨è·å–access tokenå¹¶è°ƒç”¨å¾®ä¿¡APIè·å–ticket12345678910111213141516171819202122232425262728293031@Overridepublic String createQrCodeTicket() throws Exception &#123; // 1. æ£€æŸ¥ç¼“å­˜ä¸­æ˜¯å¦æœ‰access token String accessToken = weixinAccessToken.getIfPresent(appid); if (null == accessToken) &#123; // æ²¡æœ‰ç¼“å­˜åˆ™å‘å¾®ä¿¡æœåŠ¡å™¨è¯·æ±‚ï¼Œéœ€è¦appidå’Œsecretå‚æ•° Call&lt;WeixinTokenRes&gt; call = weixinApiService.getToken(&quot;client_credential&quot;, appid, appSecret); WeixinTokenRes weixinTokenRes = call.execute().body(); assert weixinTokenRes != null; accessToken = weixinTokenRes.getAccess_token(); weixinAccessToken.put(appid, accessToken); &#125; // 2. ä½¿ç”¨access tokenè°ƒç”¨å¾®ä¿¡APIç”ŸæˆäºŒç»´ç  WeixinQrCodeReq weixinQrCodeReq = WeixinQrCodeReq.builder() .expire_seconds(2592000) .action_name(WeixinQrCodeReq.ActionNameTypeVO.QR_SCENE.getCode()) .action_info(WeixinQrCodeReq.ActionInfo.builder() .scene(WeixinQrCodeReq.ActionInfo.Scene.builder() .scene_id(100601) .build()) .build()) .build(); // 3. è·å–å¾®ä¿¡è¿”å›çš„ticket Call&lt;WeixinQrCodeRes&gt; call = weixinApiService.createQrCode(accessToken, weixinQrCodeReq); WeixinQrCodeRes weixinQrCodeRes = call.execute().body(); assert null != weixinQrCodeRes; // 4. è¿”å›ticketç»™å‰ç«¯ return weixinQrCodeRes.getTicket();&#125; 6. æµè§ˆå™¨æ˜¾ç¤ºäºŒç»´ç 1qrCodeImg.src = https://mp.weixin.qq.com/cgi-bin/showqrcode?ticket=$&#123;ticket&#125;; 7-8. ç”¨æˆ·æ‰«ç ä¸å¾®ä¿¡æœåŠ¡å™¨å›è°ƒ12345678910111213141516171819202122@PostMapping(value = &quot;receive&quot;, produces = &quot;application/xml; charset=UTF-8&quot;)public String post(@RequestBody String requestBody, @RequestParam(&quot;signature&quot;) String signature, @RequestParam(&quot;timestamp&quot;) String timestamp, @RequestParam(&quot;nonce&quot;) String nonce, @RequestParam(&quot;openid&quot;) String openid, @RequestParam(name = &quot;encrypt_type&quot;, required = false) String encType, @RequestParam(name = &quot;msg_signature&quot;, required = false) String msgSignature) &#123; try &#123; // æ¶ˆæ¯è½¬æ¢ MessageTextEntity message = XmlUtil.xmlToBean(requestBody, MessageTextEntity.class); // å¤„ç†æ‰«ç äº‹ä»¶ if (&quot;event&quot;.equals(message.getMsgType()) &amp;&amp; &quot;SCAN&quot;.equals(message.getEvent())) &#123; // ä¿å­˜ç™»å½•çŠ¶æ€ï¼ˆticketä¸openidçš„ç»‘å®šï¼‰ loginService.saveLoginState(message.getTicket(), openid); return buildMessageTextEntity(openid, &quot;ç™»å½•æˆåŠŸ&quot;); &#125; // ... &#125; // ...&#125; 9-10. æµè§ˆå™¨è½®è¯¢ä¸ç™»å½•çŠ¶æ€éªŒè¯12345678910111213141516171819// å‰ç«¯è½®è¯¢æ£€æŸ¥ç™»å½•çŠ¶æ€const intervalId = setInterval(() =&gt; &#123; checkLoginStatus(ticket, intervalId);&#125;, 3000); // æ¯3ç§’æ£€æŸ¥ä¸€æ¬¡function checkLoginStatus(ticket, intervalId) &#123; fetch(`http://localhost:8091/api/v1/login/check_login?ticket=$&#123;ticket&#125;`) .then(response =&gt; response.json()) .then(data =&gt; &#123; if (data.code === &quot;0000&quot;) &#123; console.info(&quot;login success&quot;); // åœæ­¢è½®è¯¢ clearInterval(intervalId); // ä¿å­˜ç™»å½• token åˆ° cookie // ... &#125; &#125;) // ...&#125; ç±»è®¾è®¡commonæ¨¡å— Constantsç±»çš„ä½œç”¨ å®šä¹‰é€šç”¨å¸¸é‡ï¼šå¦‚SPLITå¸¸é‡ç”¨äºå­—ç¬¦ä¸²åˆ†å‰² ç»Ÿä¸€å“åº”ç ç®¡ç†ï¼šé€šè¿‡ResponseCodeæšä¸¾å®šä¹‰æ ‡å‡†åŒ–çš„APIå“åº”ç å’Œä¿¡æ¯ è®¢å•çŠ¶æ€ç®¡ç†ï¼šé€šè¿‡OrderStatusEnumæšä¸¾å®šä¹‰æ ‡å‡†åŒ–çš„è®¢å•çŠ¶æ€æµè½¬ æ³¨è§£è§£æ@AllArgsConstructorä½œç”¨ï¼šè‡ªåŠ¨ç”ŸæˆåŒ…å«æ‰€æœ‰å­—æ®µçš„æ„é€ æ–¹æ³• @NoArgsConstructorä½œç”¨ï¼šè‡ªåŠ¨ç”Ÿæˆæ— å‚æ„é€ æ–¹æ³• @Getterä½œç”¨ï¼šè‡ªåŠ¨ç”Ÿæˆæ‰€æœ‰å­—æ®µçš„getteræ–¹æ³• AppExceptionç±»çš„ä½œç”¨ï¼šAppExceptionæ˜¯é¡¹ç›®ä¸­å®šä¹‰çš„è‡ªå®šä¹‰è¿è¡Œæ—¶å¼‚å¸¸ç±»ï¼Œä¸»è¦ç”¨äºç»Ÿä¸€ç®¡ç†å’Œå¤„ç†ä¸šåŠ¡é€»è¾‘ä¸­çš„å¼‚å¸¸æƒ…å†µã€‚å®šä¹‰äº†ä¸¤ä¸ªæ ¸å¿ƒå­—æ®µ code ï¼šå¼‚å¸¸ç ï¼Œç”¨äºæ ‡è¯†ä¸åŒç±»å‹çš„å¼‚å¸¸ info ï¼šå¼‚å¸¸æè¿°ä¿¡æ¯ï¼Œæä¾›è¯¦ç»†çš„é”™è¯¯è¯´æ˜ @EqualsAndHashCode(callSuper = true)ä½œç”¨ï¼šä¸»è¦ç”¨äºè‡ªåŠ¨ç”ŸæˆJavaå¯¹è±¡çš„equals()å’ŒhashCode()æ–¹æ³•ï¼Œå…¶å‚æ•°callSuperçš„ä½œç”¨æ˜¯ï¼šæ˜¯å¦è°ƒç”¨çˆ¶ç±»çš„equalså’ŒhashCodeæ–¹æ³•ã€‚é»˜è®¤æƒ…å†µä¸‹ä¸º falseï¼Œå³ä¸ä¼šè°ƒç”¨çˆ¶ç±»çš„æ–¹æ³•å‚è€ƒæ–‡ç«  Reponseç±»çš„ä½œç”¨ï¼šResponseæ˜¯é¡¹ç›®ä¸­å®šä¹‰çš„æ ‡å‡†APIå“åº”å°è£…ç±»ï¼Œä¸»è¦ç”¨äºç»Ÿä¸€è§„èŒƒå‰åç«¯äº¤äº’çš„æ•°æ®æ ¼å¼ã€‚åŒ…å«ä¸‰ä¸ªæ ¸å¿ƒå­—æ®µï¼š code ï¼šå“åº”çŠ¶æ€ç  info ï¼šå“åº”æè¿°ä¿¡æ¯ data ï¼šæ³›å‹æ•°æ®å­—æ®µ @Data è‡ªåŠ¨ç”Ÿæˆæ‰€æœ‰å­—æ®µçš„getterå’Œsetteræ–¹æ³• è‡ªåŠ¨ç”ŸæˆtoString()æ–¹æ³•ï¼Œæ ¼å¼åŒ–è¾“å‡ºå¯¹è±¡ä¿¡æ¯ è‡ªåŠ¨ç”Ÿæˆequals()å’ŒhashCode()æ–¹æ³•ï¼Œæ”¯æŒå¯¹è±¡æ¯”è¾ƒ è‡ªåŠ¨ç”ŸæˆcanEqual()æ–¹æ³•ï¼Œç”¨äºåˆ¤æ–­å¯¹è±¡æ˜¯å¦ä¸ºåŒä¸€ç±»å‹ @Builder æä¾›å»ºé€ è€…æ¨¡å¼çš„å®ç°ï¼Œæ”¯æŒé“¾å¼è°ƒç”¨è®¾ç½®å±æ€§ ç”Ÿæˆé™æ€çš„builder()æ–¹æ³•ï¼Œç”¨äºåˆ›å»ºBuilderå®ä¾‹ ç”ŸæˆBuilderå†…éƒ¨ç±»ï¼ŒåŒ…å«å„ä¸ªå­—æ®µçš„setteræ–¹æ³• ç‰¹åˆ«é€‚åˆåˆ›å»ºå±æ€§è¾ƒå¤šçš„å¯¹è±¡ï¼Œä½¿ä»£ç æ›´ç®€æ´ã€å¯è¯»æ€§æ›´é«˜ domainæ¨¡å— domainåŒ…åŒ…å«äº†ä»¥ä¸‹å››ç±»ï¼š po/WeixinTemplateMessageVO.java - å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯å€¼å¯¹è±¡ req/WeixinQrCodeReq.java - å¾®ä¿¡äºŒç»´ç è¯·æ±‚æ•°æ®å°è£…ç±» res/WeixinQrCodeRes.java - å¾®ä¿¡äºŒç»´ç å“åº”æ•°æ®å°è£…ç±» res/WeixinTokenRes.java - å¾®ä¿¡AccessTokenå“åº”æ•°æ®å°è£…ç±» å‘é€æ¨¡æ¿æ¶ˆæ¯è·å–AccessTokenç”Ÿæˆå¸¦å‚çš„äºŒç»´ç  webæ¨¡å— å…³äº **@configuration**ï¼šç”¨è¯¥æ³¨è§£ä¿®é¥°çš„ç±»æœ¬èº«ä¹Ÿæ˜¯ä¸€ä¸ªBeanï¼Œä½†å®ƒçš„ä¸»è¦èŒè´£æ˜¯ç”Ÿäº§å…¶ä»–Beanï¼Œé‡Œé¢åŒ…å«äº†ç”¨äºå®šä¹‰å’Œç»„è£…Springå®¹å™¨ä¸­Beançš„é…ç½®ä¿¡æ¯ã€‚@Configurationå’Œ@Componentçš„åŒºåˆ«ï¼šå…³é”®åœ¨äº@Configurationä½¿ç”¨äº†CGLIBä»£ç†ï¼Œä¿è¯äº†æ‰€æœ‰å¸¦æœ‰@Beanæ³¨è§£çš„æ–¹æ³•éƒ½æ˜¯å•ä¾‹çš„ã€‚ å…¶ä¸­Guavaåœ¨æœ¬é¡¹ç›®çš„ä¸»è¦ä½œç”¨æ˜¯ä½œä¸ºæœ¬åœ°ç¼“å­˜ç¼“å­˜AccessTokenå’ŒOpenIdTokenï¼Œè¿™é‡Œä¹Ÿå¯ä»¥ç”¨Redisæ›¿ä»£ã€‚Retrofit2ç”¨äºä¸å¾®ä¿¡APIè¿›è¡Œé€šä¿¡ã€‚ LoginControllerç±»çš„ä½œç”¨ï¼šLoginControlleræ˜¯é¡¹ç›®ä¸­å®šä¹‰çš„ç™»å½•æ§åˆ¶å™¨ç±»ï¼Œä¸»è¦è´Ÿè´£å¤„ç†ç”¨æˆ·ç™»å½•ç›¸å…³çš„è¯·æ±‚ã€‚å†…æœ‰ä¸¤ä¸ªæ–¹æ³•weixinQrCodeTicket()ç”Ÿæˆå¾®ä¿¡äºŒç»´ç ï¼Œä»¥åŠcheckLogin()ç”¨äºæ£€æŸ¥ç™»å½•çŠ¶æ€ã€‚ serviceæ¨¡å— æ³¨æ„äº‹é¡¹åœ¨webåŒ…ä¸‹çš„application-dev.ymlä¸­ï¼Œå¢åŠ teplate_idå­—æ®µï¼š 12345678# å¾®ä¿¡å…¬ä¼—å·å¯¹æ¥weixin: config: originalid: #å¡«å†™ä½ çš„originalid token: #å¡«å†™ä½ çš„token app-id: #å¡«å†™ä½ çš„app-id app-secret: #å¡«å†™ä½ çš„app-secret template_id: #å¡«å†™ä½ çš„template_id æ‰©å±• å°†æœ¬åœ°ç¼“å­˜Guavaä¿®æ”¹ä¸ºRedis 1. åœ¨pom.xmlä¸­æ·»åŠ Redisçš„ä¾èµ–è¿™é‡Œæˆ‘ä»¬å¯ä»¥é€‰æ‹©å¼•å…¥Redisæˆ–è€…ç›´æ¥å¼•å…¥Redissonï¼Œè¿™é‡Œæˆ‘ä»¬é€‰æ‹©Redisson åœ¨webæ¨¡å—ä¸‹çš„pom.xmlä¸­æ·»åŠ redissonçš„ä¾èµ–ï¼š 1234 &lt;dependency&gt; &lt;groupId&gt;org.redisson&lt;/groupId&gt; &lt;artifactId&gt;redisson-spring-boot-starter&lt;/artifactId&gt;&lt;/dependency&gt; æ³¨æ„ï¼šè¿™é‡Œä¸éœ€è¦å¼•å…¥ç‰ˆæœ¬å·ï¼Œå› ä¸ºæ ¹pomå·²ç»å®šä¹‰äº†ç‰ˆæœ¬å· 2. åœ¨application-dev.ymlä¸­æ·»åŠ Redisçš„é…ç½®æ³¨æ„ï¼šå¦‚æœæ²¡æœ‰å¯†ç åŠ¡å¿…åˆ é™¤passwordè¿™è¡Œï¼Œä¸ç„¶æœ‰å¯èƒ½å‡ºç°è¿æ¥é—®é¢˜ 123456spring: redis: host: 127.0.0.1 port: 6379 password: #è¿™é‡Œç”¨ä½ è‡ªå·±çš„å¯†ç ï¼Œå¦‚æœæ²¡æœ‰å¯†ç è¯·åˆ é™¤æ­¤è¡Œ database: 0 3. å®šä¹‰RedissonConfigé…ç½®ç±»å› ä¸ºæˆ‘ä»¬å¼•å…¥äº†redisson-spring-boot-starterï¼ŒSpring Bootä¼šè‡ªåŠ¨å¸®åŠ©æˆ‘ä»¬é…ç½®redissonï¼Œå¯ä»¥é€‰æ‹©ä¸å®šä¹‰RedissonConfig ä½†æ˜¯ï¼Œå¦‚æœå‘ç°åœ¨Redisä¸­å­˜çš„æ•°æ®å‡ºç°ä¹±ç çš„æƒ…å†µï¼Œå¯ä»¥é€‰æ‹©å®šä¹‰RedissonConfigæ¥é¿å…è¿™ä¸ªé—®é¢˜ï¼š 1234567891011121314151617181920212223242526272829303132333435363738394041424344454647484950515253package cn.bugstack.config;import com.fasterxml.jackson.databind.ObjectMapper;import com.fasterxml.jackson.databind.SerializationFeature;import com.fasterxml.jackson.datatype.jsr310.JavaTimeModule;import org.redisson.Redisson;import org.redisson.api.RedissonClient;import org.redisson.codec.JsonJacksonCodec;import org.redisson.config.Config;import org.redisson.config.SingleServerConfig;import org.springframework.beans.factory.annotation.Value;import org.springframework.context.annotation.Bean;import org.springframework.context.annotation.Configuration;import org.springframework.util.StringUtils;/** * @author æ¸£æ¸£ç†Š * @description Redissoné…ç½®ç±» * @create 2025-09-10 17:39 */@Configurationpublic class RedissonConfig &#123; @Value(&quot;$&#123;spring.redis.host&#125;&quot;) private String host; @Value(&quot;$&#123;spring.redis.port&#125;&quot;) private String port; @Value(&quot;$&#123;spring.redis.password:&#125;&quot;) private String password; @Bean public RedissonClient redissonClient() &#123; Config config = new Config(); SingleServerConfig serverConfig = config.useSingleServer() .setAddress(&quot;redis://&quot; + host + &quot;:&quot; + port); // 1. åˆ›å»ºè‡ªå®šä¹‰ ObjectMapper ObjectMapper mapper = new ObjectMapper(); // 2. æ³¨å†ŒJava 8æ—¶é—´æ¨¡å— mapper.registerModule(new JavaTimeModule()); // 3. ç¦ç”¨æ—¶é—´æˆ³æ ¼å¼ mapper.disable(SerializationFeature.WRITE_DATES_AS_TIMESTAMPS); // 4. ä½¿ç”¨è‡ªå®šä¹‰ObjectMapperåˆ›å»ºç¼–è§£ç å™¨ config.setCodec(new JsonJacksonCodec(mapper)); if (StringUtils.hasText(password)) &#123; serverConfig.setPassword(password); &#125; return Redisson.create(config); &#125;&#125; 4. æµ‹è¯•Redissonè¿æ¥å¦‚æœå‰é¢éƒ¨åˆ†éƒ½æ²¡æœ‰é—®é¢˜ï¼Œè¿™é‡Œçš„æµ‹è¯•ç±»åº”è¯¥ä¹Ÿéƒ½èƒ½é¡ºåˆ©é€šè¿‡ï¼Œæµ‹è¯•ç±»åº”è¯¥ä½äºwebæ¨¡å—ä¸‹çš„testæ–‡ä»¶å¤¹ä¸­ 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051package cn.bugstack.test;import org.junit.jupiter.api.Test;import org.redisson.api.RBucket;import org.redisson.api.RMap;import org.redisson.api.RSet;import org.redisson.api.RedissonClient;import org.springframework.boot.test.context.SpringBootTest;import org.springframework.test.context.ActiveProfiles;import javax.annotation.Resource;import java.util.concurrent.TimeUnit;import static org.junit.jupiter.api.Assertions.*;/** * @author æ¸£æ¸£ç†Š * @description æµ‹è¯• Redissonæ˜¯å¦é…ç½®æˆåŠŸ * @create 2025-09-09 21ï¼š10 */@SpringBootTest@ActiveProfiles(&quot;dev&quot;)public class RedissonTest &#123; @Resource private RedissonClient redissonClient; /** * æµ‹è¯•Redissonè¿æ¥æ˜¯å¦æ­£å¸¸ */ @Test public void testConnection() &#123; assertNotNull(redissonClient, &quot;RedissonClient should not be null&quot;); System.out.println(&quot;Redissonè¿æ¥æµ‹è¯•æˆåŠŸï¼&quot;); &#125; /** * æµ‹è¯•å­—ç¬¦ä¸²æ“ä½œ */ @Test public void testStringOperations() &#123; String key = &quot;test:string:key&quot;; RBucket&lt;String&gt; bucket = redissonClient.getBucket(key); bucket.set(&quot;Hello Redisson!&quot;); System.out.println(bucket.get()); bucket.delete(); assertNull(redissonClient.getBucket(key).get()); System.out.println(&quot;å­—ç¬¦ä¸²æ“ä½œæµ‹è¯•æˆåŠŸï¼Œå¹¶å·²æ¸…ç†æµ‹è¯•æ•°æ®&quot;); &#125;&#125; å¦‚æœä¸¤ä¸ªæ–¹æ³•éƒ½é€šè¿‡ï¼Œåˆ™å¯ä»¥è®¤ä¸ºRedissoné…ç½®æ²¡æœ‰é—®é¢˜ 5. Redissonä»£æ›¿Guavaåçš„å®Œæ•´ä»£ç 123456789101112131415161718192021222324252627282930313233343536373839404142434445464748495051525354555657585960616263646566676869707172737475767778798081828384858687888990919293949596979899100101102103104105106107108109110111112113114115116117118119120121122123124125126127128129130131132133134135package cn.bugstack.service.impl;import cn.bugstack.domain.po.WeixinTemplateMessageVO;import cn.bugstack.domain.req.WeixinQrCodeReq;import cn.bugstack.domain.res.WeixinQrCodeRes;import cn.bugstack.domain.res.WeixinTokenRes;import cn.bugstack.service.ILoginService;import cn.bugstack.service.weixin.IWeixinApiService;import org.redisson.api.RBucket;import org.redisson.api.RedissonClient;import org.slf4j.Logger;import org.slf4j.LoggerFactory;import org.springframework.beans.factory.annotation.Value;import org.springframework.stereotype.Service;import retrofit2.Call;import javax.annotation.Resource;import java.io.IOException;import java.time.Duration;import java.util.HashMap;import java.util.Map;import static cn.bugstack.common.constants.RedisConstants.*;@Servicepublic class WeixinLoginServiceImpl implements ILoginService &#123; private static final Logger logger = LoggerFactory.getLogger(WeixinLoginServiceImpl.class); @Value(&quot;$&#123;weixin.config.app-id&#125;&quot;) private String appid; @Value(&quot;$&#123;weixin.config.app-secret&#125;&quot;) private String appSecret; @Value(&quot;$&#123;weixin.config.template_id&#125;&quot;) private String template_id; @Resource private IWeixinApiService weixinApiService; @Resource private RedissonClient redissonClient; @Override public String createQrCodeTicket() &#123; try &#123; logger.info(&quot;å¼€å§‹åˆ›å»ºå¾®ä¿¡äºŒç»´ç ticket, appid: &#123;&#125;&quot;, appid); // 1. è·å– accessToken String accessToken = getAccessToken(); // 2. ç”Ÿæˆ ticket WeixinQrCodeReq weixinQrCodeReq = WeixinQrCodeReq.builder() .expire_seconds(2592000) .action_name(WeixinQrCodeReq.ActionNameTypeVO.QR_SCENE.getCode()) .action_info(WeixinQrCodeReq.ActionInfo.builder() .scene(WeixinQrCodeReq.ActionInfo.Scene.builder() .scene_id(100601) .build()) .build()) .build(); Call&lt;WeixinQrCodeRes&gt; call = weixinApiService.createQrCode(accessToken, weixinQrCodeReq); WeixinQrCodeRes weixinQrCodeRes = call.execute().body(); if (weixinQrCodeRes == null || weixinQrCodeRes.getTicket() == null) &#123; throw new RuntimeException(&quot;å¾®ä¿¡APIè¿”å›ç©ºå“åº”æˆ–ç¼ºå°‘ticket&quot;); &#125; logger.info(&quot;æˆåŠŸåˆ›å»ºå¾®ä¿¡äºŒç»´ç ticket: &#123;&#125;&quot;, weixinQrCodeRes.getTicket()); return weixinQrCodeRes.getTicket(); &#125; catch (Exception e) &#123; logger.error(&quot;åˆ›å»ºå¾®ä¿¡äºŒç»´ç ticketå¤±è´¥&quot;, e); throw new RuntimeException(&quot;Failed to create QR code ticket&quot;, e); &#125; &#125; @Override public String checkLogin(String ticket) &#123; String key = OPENID_KEY_PREFIX + ticket; String result = redissonClient.&lt;String&gt;getBucket(key).get(); return result != null ? result : &quot;&quot;; &#125; @Override public void saveLoginState(String ticket, String openid) throws IOException &#123; try &#123; String key = OPENID_KEY_PREFIX + ticket; RBucket&lt;String&gt; bucket = redissonClient.getBucket(key); bucket.set(openid, Duration.ofHours(OPENID_TTL)); logger.info(&quot;å·²ä¿å­˜ç™»å½•çŠ¶æ€, ticket: &#123;&#125;, openid: &#123;&#125;&quot;, ticket, openid); // 1. è·å– accessToken String accessToken = getAccessToken(); // 2. å‘é€æ¨¡æ¿æ¶ˆæ¯ Map&lt;String, Map&lt;String, String&gt;&gt; data = new HashMap&lt;&gt;(); WeixinTemplateMessageVO.put(data, WeixinTemplateMessageVO.TemplateKey.USER, openid); WeixinTemplateMessageVO templateMessageDTO = new WeixinTemplateMessageVO(openid, template_id); templateMessageDTO.setUrl(&quot;http://www.zhazhabear.site&quot;); templateMessageDTO.setData(data); Call&lt;Void&gt; call = weixinApiService.sendMessage(accessToken, templateMessageDTO); call.execute(); logger.info(&quot;å·²å‘é€å¾®ä¿¡æ¨¡æ¿æ¶ˆæ¯, openid: &#123;&#125;&quot;, openid); &#125; catch (Exception e) &#123; logger.error(&quot;ä¿å­˜ç™»å½•çŠ¶æ€æˆ–å‘é€æ¨¡æ¿æ¶ˆæ¯å¤±è´¥&quot;, e); throw e; // é‡æ–°æŠ›å‡ºå¼‚å¸¸ &#125; &#125; private String getAccessToken() throws IOException &#123; String key = ACCESS_TOKEN_KEY_PREFIX + appid; RBucket&lt;String&gt; bucket = redissonClient.getBucket(key); String accessToken = bucket.get(); if (null == accessToken) &#123; logger.info(&quot;ç¼“å­˜ä¸­æœªæ‰¾åˆ°accessTokenï¼Œä»å¾®ä¿¡APIè·å–&quot;); Call&lt;WeixinTokenRes&gt; call = weixinApiService.getToken(&quot;client_credential&quot;, appid, appSecret); WeixinTokenRes weixinTokenRes = call.execute().body(); if (weixinTokenRes != null &amp;&amp; weixinTokenRes.getAccess_token() != null) &#123; accessToken = weixinTokenRes.getAccess_token(); bucket.set(accessToken, Duration.ofHours(ACCESS_TOKEN_TTL)); logger.info(&quot;æˆåŠŸè·å–å¹¶ç¼“å­˜accessToken&quot;); &#125; else &#123; throw new IOException(&quot;ä»å¾®ä¿¡APIè·å–accessTokenå¤±è´¥&quot;); &#125; &#125; else &#123; logger.debug(&quot;ä»ç¼“å­˜ä¸­è·å–accessToken&quot;); &#125; return accessToken; &#125;&#125;","tags":[{"name":"é¡¹ç›®å­¦ä¹ ","slug":"é¡¹ç›®å­¦ä¹ ","permalink":"https://www.zhazhabear.site/tags/%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0/"},{"name":"åç«¯å¼€å‘","slug":"åç«¯å¼€å‘","permalink":"https://www.zhazhabear.site/tags/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/"},{"name":"å¾®ä¿¡ç™»å½•","slug":"å¾®ä¿¡ç™»å½•","permalink":"https://www.zhazhabear.site/tags/%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95/"}],"categories":[{"name":"å°å‹æ”¯ä»˜å•†åŸå­¦ä¹ ","slug":"å°å‹æ”¯ä»˜å•†åŸå­¦ä¹ ","permalink":"https://www.zhazhabear.site/categories/%E5%B0%8F%E5%9E%8B%E6%94%AF%E4%BB%98%E5%95%86%E5%9F%8E%E5%AD%A6%E4%B9%A0/"}]}],"categories":[{"name":"AI Agentå­¦ä¹ ","slug":"AI-Agentå­¦ä¹ ","permalink":"https://www.zhazhabear.site/categories/AI-Agent%E5%AD%A6%E4%B9%A0/"},{"name":"å°å‹æ”¯ä»˜å•†åŸå­¦ä¹ ","slug":"å°å‹æ”¯ä»˜å•†åŸå­¦ä¹ ","permalink":"https://www.zhazhabear.site/categories/%E5%B0%8F%E5%9E%8B%E6%94%AF%E4%BB%98%E5%95%86%E5%9F%8E%E5%AD%A6%E4%B9%A0/"}],"tags":[{"name":"å‰ç«¯é¡µé¢","slug":"å‰ç«¯é¡µé¢","permalink":"https://www.zhazhabear.site/tags/%E5%89%8D%E7%AB%AF%E9%A1%B5%E9%9D%A2/"},{"name":"é¡¹ç›®å­¦ä¹ ","slug":"é¡¹ç›®å­¦ä¹ ","permalink":"https://www.zhazhabear.site/tags/%E9%A1%B9%E7%9B%AE%E5%AD%A6%E4%B9%A0/"},{"name":"åç«¯å¼€å‘","slug":"åç«¯å¼€å‘","permalink":"https://www.zhazhabear.site/tags/%E5%90%8E%E7%AB%AF%E5%BC%80%E5%8F%91/"},{"name":"Docker","slug":"Docker","permalink":"https://www.zhazhabear.site/tags/Docker/"},{"name":"Portainer","slug":"Portainer","permalink":"https://www.zhazhabear.site/tags/Portainer/"},{"name":"Ollama","slug":"Ollama","permalink":"https://www.zhazhabear.site/tags/Ollama/"},{"name":"Redis","slug":"Redis","permalink":"https://www.zhazhabear.site/tags/Redis/"},{"name":"è¿ç»´","slug":"è¿ç»´","permalink":"https://www.zhazhabear.site/tags/%E8%BF%90%E7%BB%B4/"},{"name":"æ”¯ä»˜å®æ²™ç®±","slug":"æ”¯ä»˜å®æ²™ç®±","permalink":"https://www.zhazhabear.site/tags/%E6%94%AF%E4%BB%98%E5%AE%9D%E6%B2%99%E7%AE%B1/"},{"name":"Natapp","slug":"Natapp","permalink":"https://www.zhazhabear.site/tags/Natapp/"},{"name":"å¾®ä¿¡ç™»å½•","slug":"å¾®ä¿¡ç™»å½•","permalink":"https://www.zhazhabear.site/tags/%E5%BE%AE%E4%BF%A1%E7%99%BB%E5%BD%95/"}]}